{% extends "base.html" %}

{% block title %}Evidencia - {{ evidence.original_filename }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('cases.index') }}">Casos</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('cases.detail', case_id=case.id) }}">{{ case.numero_orden }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('evidence.case_evidence_list', case_id=case.id) }}">Evidencias</a></li>
            <li class="breadcrumb-item active">{{ evidence.original_filename }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>
                <i class="bi bi-file-earmark-text"></i> {{ evidence.original_filename }}
                {% if evidence.is_encrypted %}
                    <span class="badge bg-success"><i class="bi bi-lock"></i> Encriptada</span>
                {% endif %}
            </h2>
            <p class="text-muted">
                <strong>Caso:</strong> <a href="{{ url_for('cases.detail', case_id=case.id) }}">{{ case.numero_orden }}</a>
            </p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
                <a href="{{ url_for('evidence.download_evidence', evidence_id=evidence.id) }}" class="btn btn-success">
                    <i class="bi bi-download"></i> Descargar
                </a>
                <form method="POST" action="{{ url_for('evidence.verify_integrity', evidence_id=evidence.id) }}" style="display: inline;">
                    {{ csrf_token() }}
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-shield-check"></i> Verificar Integridad
                    </button>
                </form>
                <form method="POST" action="{{ url_for('evidence.delete_evidence', evidence_id=evidence.id) }}"
                      onsubmit="return confirm('¿Está seguro de marcar esta evidencia como eliminada?');"
                      style="display: inline;">
                    {{ csrf_token() }}
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Evidence Details -->
        <div class="col-md-8">
            <!-- Preview Section -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-eye"></i> Vista Previa
                </div>
                <div class="card-body">
                    {% set mime = evidence.mime_type or '' %}
                    {% set preview_url = url_for('evidence.preview_evidence', evidence_id=evidence.id) %}

                    <!-- Image Preview -->
                    {% if mime.startswith('image/') %}
                        <div class="text-center">
                            <img src="{{ preview_url }}"
                                 alt="{{ evidence.original_filename }}"
                                 class="img-fluid"
                                 style="max-height: 600px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        </div>

                    <!-- PDF Preview -->
                    {% elif mime == 'application/pdf' %}
                        <div style="height: 600px;">
                            <iframe src="{{ preview_url }}"
                                    width="100%"
                                    height="100%"
                                    style="border: 1px solid #ddd; border-radius: 4px;">
                            </iframe>
                        </div>

                    <!-- Video Preview -->
                    {% elif mime.startswith('video/') %}
                        <div class="text-center">
                            <video controls
                                   style="max-width: 100%; max-height: 600px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <source src="{{ preview_url }}" type="{{ mime }}">
                                Su navegador no soporta la reproducción de video.
                            </video>
                        </div>

                    <!-- Audio Preview -->
                    {% elif mime.startswith('audio/') %}
                        <div class="text-center p-4">
                            <i class="bi bi-music-note-beamed" style="font-size: 4rem; color: #6c757d;"></i>
                            <div class="mt-3">
                                <audio controls style="width: 100%; max-width: 500px;">
                                    <source src="{{ preview_url }}" type="{{ mime }}">
                                    Su navegador no soporta la reproducción de audio.
                                </audio>
                            </div>
                        </div>

                    <!-- Text/Code Preview -->
                    {% elif mime.startswith('text/') or mime == 'application/json' or mime == 'application/xml' %}
                        <div style="height: 400px; overflow-y: auto;">
                            <iframe src="{{ preview_url }}"
                                    width="100%"
                                    height="100%"
                                    style="border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                            </iframe>
                        </div>

                    <!-- Office Documents Preview Info -->
                    {% elif mime in ['application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                      'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                      'application/msword',
                                      'application/vnd.ms-excel',
                                      'application/vnd.ms-powerpoint'] %}
                        <div class="text-center p-5">
                            {% if 'word' in mime or mime == 'application/msword' %}
                                <i class="bi bi-file-word" style="font-size: 5rem; color: #2b579a;"></i>
                                <h5 class="mt-3">Documento de Word</h5>
                            {% elif 'sheet' in mime or mime == 'application/vnd.ms-excel' %}
                                <i class="bi bi-file-excel" style="font-size: 5rem; color: #217346;"></i>
                                <h5 class="mt-3">Hoja de Cálculo Excel</h5>
                            {% elif 'presentation' in mime or mime == 'application/vnd.ms-powerpoint' %}
                                <i class="bi bi-file-ppt" style="font-size: 5rem; color: #d24726;"></i>
                                <h5 class="mt-3">Presentación PowerPoint</h5>
                            {% endif %}
                            <p class="text-muted">
                                Para ver este documento, descárguelo usando el botón "Descargar" arriba.
                            </p>
                            <a href="https://view.officeapps.live.com/op/view.aspx?src={{ preview_url | urlencode }}"
                               target="_blank"
                               class="btn btn-primary mt-2">
                                <i class="bi bi-box-arrow-up-right"></i> Abrir con Office Online (Externo)
                            </a>
                            <div class="alert alert-warning mt-3 mb-0">
                                <i class="bi bi-exclamation-triangle"></i>
                                Advertencia: Office Online es un servicio externo de Microsoft.
                                Úselo bajo su propio riesgo si la evidencia contiene información sensible.
                            </div>
                        </div>

                    <!-- No preview available -->
                    {% else %}
                        <div class="text-center p-5">
                            <i class="bi bi-file-earmark" style="font-size: 5rem; color: #6c757d;"></i>
                            <h5 class="mt-3">Vista previa no disponible</h5>
                            <p class="text-muted">
                                Este tipo de archivo ({{ mime or 'desconocido' }}) no puede ser visualizado en el navegador.
                            </p>
                            <a href="{{ url_for('evidence.download_evidence', evidence_id=evidence.id) }}"
                               class="btn btn-success mt-2">
                                <i class="bi bi-download"></i> Descargar Archivo
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Basic Information -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-info-circle"></i> Información Básica
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 30%;">Tipo:</th>
                            <td>
                                {% if evidence.evidence_type == EvidenceType.IMAGEN %}
                                    <span class="badge bg-primary"><i class="bi bi-image"></i> Imagen</span>
                                {% elif evidence.evidence_type == EvidenceType.VIDEO %}
                                    <span class="badge bg-info"><i class="bi bi-camera-video"></i> Video</span>
                                {% elif evidence.evidence_type == EvidenceType.AUDIO %}
                                    <span class="badge bg-success"><i class="bi bi-music-note"></i> Audio</span>
                                {% elif evidence.evidence_type == EvidenceType.DOCUMENTO %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-file-text"></i> Documento</span>
                                {% elif evidence.evidence_type == EvidenceType.EMAIL %}
                                    <span class="badge bg-secondary"><i class="bi bi-envelope"></i> Email</span>
                                {% elif evidence.evidence_type == EvidenceType.CAPTURA_WEB %}
                                    <span class="badge bg-dark"><i class="bi bi-globe"></i> Captura Web</span>
                                {% elif evidence.evidence_type == EvidenceType.DATOS_DIGITALES %}
                                    <span class="badge bg-info"><i class="bi bi-database"></i> Datos Digitales</span>
                                {% else %}
                                    <span class="badge bg-secondary"><i class="bi bi-file"></i> Otro</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Nombre Original:</th>
                            <td><code>{{ evidence.original_filename }}</code></td>
                        </tr>
                        <tr>
                            <th>Nombre Almacenado:</th>
                            <td><code>{{ evidence.filename }}</code></td>
                        </tr>
                        <tr>
                            <th>Tipo MIME:</th>
                            <td><code>{{ evidence.mime_type or 'No detectado' }}</code></td>
                        </tr>
                        <tr>
                            <th>Tamaño:</th>
                            <td><strong>{{ "%.2f"|format(evidence.file_size / 1024 / 1024) }} MB</strong> ({{ "{:,}".format(evidence.file_size) }} bytes)</td>
                        </tr>
                        <tr>
                            <th>Descripción:</th>
                            <td>{{ evidence.description }}</td>
                        </tr>
                        {% if evidence.tags %}
                        <tr>
                            <th>Etiquetas:</th>
                            <td>
                                {% for tag in evidence.tags.split(',') %}
                                    <span class="badge bg-secondary">{{ tag.strip() }}</span>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Forensic Hashes -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-fingerprint"></i> Hashes Forenses (UNE 71506)
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>SHA-256:</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" value="{{ evidence.sha256_hash }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText('{{ evidence.sha256_hash }}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>SHA-512:</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace" value="{{ evidence.sha512_hash }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText('{{ evidence.sha512_hash }}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> Los hashes fueron calculados <strong>antes</strong> de la encriptación para preservar la integridad forense.
                    </div>
                </div>
            </div>

            <!-- Encryption -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-lock"></i> Encriptación
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 30%;">Encriptada:</th>
                            <td>
                                {% if evidence.is_encrypted %}
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Sí</span>
                                {% else %}
                                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> No</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if evidence.is_encrypted %}
                        <tr>
                            <th>Algoritmo:</th>
                            <td><code>{{ evidence.encryption_algorithm }}</code></td>
                        </tr>
                        <tr>
                            <th>Nonce:</th>
                            <td><code>{{ evidence.encryption_nonce[:32] }}...</code></td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <!-- Acquisition Metadata -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-clipboard-data"></i> Metadatos de Adquisición
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 30%;">Fecha Adquisición:</th>
                            <td>{{ evidence.acquisition_date.strftime('%Y-%m-%d %H:%M:%S') if evidence.acquisition_date else 'No especificada' }}</td>
                        </tr>
                        <tr>
                            <th>Método:</th>
                            <td>{{ evidence.acquisition_method or 'No especificado' }}</td>
                        </tr>
                        {% if evidence.source_device %}
                        <tr>
                            <th>Dispositivo Origen:</th>
                            <td>{{ evidence.source_device }}</td>
                        </tr>
                        {% endif %}
                        {% if evidence.source_location %}
                        <tr>
                            <th>Ubicación Origen:</th>
                            <td>{{ evidence.source_location }}</td>
                        </tr>
                        {% endif %}
                        {% if evidence.geolocation_lat and evidence.geolocation_lon %}
                        <tr>
                            <th>Geolocalización:</th>
                            <td>
                                <i class="bi bi-geo-alt"></i>
                                Lat: {{ "%.6f"|format(evidence.geolocation_lat) }},
                                Lon: {{ "%.6f"|format(evidence.geolocation_lon) }}
                                <a href="https://www.google.com/maps?q={{ evidence.geolocation_lat }},{{ evidence.geolocation_lon }}"
                                   target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="bi bi-map"></i> Ver en Mapa
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                        {% if evidence.acquisition_notes %}
                        <tr>
                            <th>Notas:</th>
                            <td>{{ evidence.acquisition_notes }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Status and Chain of Custody -->
        <div class="col-md-4">
            <!-- Integrity Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-shield-check"></i> Estado de Integridad
                </div>
                <div class="card-body text-center">
                    {% if evidence.integrity_verified %}
                        <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-success">Integridad Verificada</h5>
                    {% else %}
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-warning">Integridad No Verificada</h5>
                    {% endif %}

                    {% if evidence.last_verification_date %}
                        <p class="text-muted mb-0">
                            Última verificación:<br>
                            {{ evidence.last_verification_date.strftime('%Y-%m-%d %H:%M:%S') }}
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Upload Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-cloud-upload"></i> Información de Subida
                </div>
                <div class="card-body">
                    <p><strong>Subida por:</strong><br>{{ evidence.uploaded_by.nombre }}</p>
                    <p><strong>Fecha/Hora:</strong><br>{{ evidence.uploaded_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    <p class="mb-0"><strong>Timestamp:</strong><br><small class="text-muted">{{ evidence.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small></p>
                </div>
            </div>

            <!-- Recent Chain of Custody -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> Cadena de Custodia
                    <a href="{{ url_for('evidence.chain_of_custody', evidence_id=evidence.id) }}" class="btn btn-sm btn-outline-primary float-end">
                        Ver Completa
                    </a>
                </div>
                <div class="card-body">
                    {% if custody_entries %}
                        <div class="timeline">
                            {% for entry in custody_entries[:5] %}
                                <div class="timeline-item mb-3">
                                    <div class="d-flex justify-content-between">
                                        <small><strong>{{ entry.action }}</strong></small>
                                        <small class="text-muted">{{ entry.timestamp.strftime('%H:%M:%S') }}</small>
                                    </div>
                                    <div class="text-muted small">
                                        {{ entry.user.nombre }}
                                        {% if entry.hash_verified %}
                                            {% if entry.hash_match %}
                                                <i class="bi bi-check-circle text-success" title="Hash verificado"></i>
                                            {% else %}
                                                <i class="bi bi-x-circle text-danger" title="Hash NO coincide"></i>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    {% if entry.notes %}
                                        <div class="text-muted small">{{ entry.notes }}</div>
                                    {% endif %}
                                </div>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                            {% endfor %}
                        </div>
                        {% if custody_entries|length > 5 %}
                            <a href="{{ url_for('evidence.chain_of_custody', evidence_id=evidence.id) }}" class="btn btn-sm btn-outline-secondary w-100 mt-2">
                                Ver todas las {{ custody_entries|length }} entradas
                            </a>
                        {% endif %}
                    {% else %}
                        <p class="text-muted mb-0">No hay entradas en la cadena de custodia.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
