{% extends "base.html" %}

{% block title %}{{ contact.contact_value }} - OSINT{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="{{ contact.get_type_icon() }}"></i> {{ contact.contact_value }}
                </h2>
                <div>
                    {% if case %}
                        <a href="{{ url_for('osint.edit', case_id=case.id, contact_id=contact.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="{{ url_for('osint.case_contacts', case_id=case.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    {% else %}
                        <a href="{{ url_for('osint.edit_no_case', contact_id=contact.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="{{ url_for('osint.index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <!-- Main Information -->
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle"></i> Información del Contacto
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Tipo:</strong></div>
                                <div class="col-sm-8">
                                    <i class="{{ contact.get_type_icon() }}"></i>
                                    <span class="badge {{ contact.get_status_badge_class() }}">
                                        {{ contact.contact_type }}
                                    </span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Valor:</strong></div>
                                <div class="col-sm-8"><code>{{ contact.contact_value }}</code></div>
                            </div>

                            {% if contact.name %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Nombre Asociado:</strong></div>
                                <div class="col-sm-8">{{ contact.name }}</div>
                            </div>
                            {% endif %}

                            {% if contact.description %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Descripción:</strong></div>
                                <div class="col-sm-8">{{ contact.description }}</div>
                            </div>
                            {% endif %}

                            {% if contact.source %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Fuente:</strong></div>
                                <div class="col-sm-8">{{ contact.source }}</div>
                            </div>
                            {% endif %}

                            {% if contact.tags %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Etiquetas:</strong></div>
                                <div class="col-sm-8">
                                    {% for tag in contact.get_tags_list() %}
                                        <span class="badge bg-secondary">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Estado:</strong></div>
                                <div class="col-sm-8">
                                    <span class="badge {{ contact.get_status_badge_class() }}">
                                        {{ contact.status }}
                                    </span>
                                </div>
                            </div>

                            {% if contact.case %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Caso Asociado:</strong></div>
                                <div class="col-sm-8">
                                    <a href="{{ url_for('cases.detail', case_id=contact.case_id) }}">
                                        {{ contact.case.numero_orden }} - {{ contact.case.objeto_investigacion[:50] }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Validation Status -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-shield-check"></i> Estado de Validación
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if contact.is_validated %}
                                <div class="alert alert-success">
                                    <h6><i class="bi bi-check-circle"></i> Contacto Validado</h6>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <strong>Fecha de Validación:</strong><br>
                                            {{ contact.validation_date.strftime('%d/%m/%Y %H:%M') }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Puntuación de Fraude:</strong><br>
                                            <span class="badge {{ contact.get_risk_badge_class() }} fs-5">
                                                {{ contact.fraud_score }}/100
                                            </span>
                                            ({{ contact.risk_level }})
                                        </div>
                                    </div>

                                    {% if contact.validation_result %}
                                    <div class="mt-3">
                                        <strong>Resumen:</strong><br>
                                        {{ contact.validation_result.get_summary().recommendation }}
                                    </div>

                                    <div class="mt-3">
                                        <a href="{{ url_for('osint.validation_detail', validation_id=contact.validation_result.id) }}"
                                           class="btn btn-sm btn-outline-info">
                                            <i class="bi bi-eye"></i> Ver Detalles Completos
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-exclamation-triangle"></i> Contacto Sin Validar</h6>
                                    <p class="mb-0">
                                        {% if contact.contact_type in ['email', 'phone'] %}
                                            Este contacto aún no ha sido validado con IPQualityScore.
                                            Usa el botón "Validar con IPQualityScore" en la sección de acciones.
                                        {% else %}
                                            Este tipo de contacto no puede ser validado automáticamente.
                                        {% endif %}
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Validation History -->
                    {% if validations %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-clock-history"></i> Historial de Validaciones
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Puntuación</th>
                                            <th>Riesgo</th>
                                            <th>Validado Por</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for validation in validations %}
                                        <tr>
                                            <td>{{ validation.validation_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td>
                                                <span class="badge {{ validation.get_risk_badge_class() }}">
                                                    {{ validation.fraud_score }}/100
                                                </span>
                                            </td>
                                            <td>{{ validation.risk_level }}</td>
                                            <td>{{ validation.validated_by.email }}</td>
                                            <td>
                                                <a href="{{ url_for('osint.validation_detail', validation_id=validation.id) }}"
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="bi bi-eye"></i> Ver
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Actions -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-lightning"></i> Acciones
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                {% if contact.contact_type in ['email', 'phone'] %}
                                {% if case %}
                                <form method="POST" action="{{ url_for('osint.validate_contact', case_id=case.id, contact_id=contact.id) }}" id="validateForm">
                                {% else %}
                                <form method="POST" action="{{ url_for('osint.validate_contact_no_case', contact_id=contact.id) }}" id="validateForm">
                                {% endif %}
                                    {{ validate_form.hidden_tag() }}
                                    {{ validate_form.contact_id }}
                                    {{ validate_form.notes(class="form-control mb-2", placeholder="Notas opcionales...") }}
                                    <button type="submit" class="btn btn-success w-100" id="validateButton">
                                        <i class="bi bi-lightning-charge"></i> Validar con IPQualityScore
                                    </button>
                                </form>
                                {% endif %}

                                {% if case %}
                                <form method="POST" action="{{ url_for('osint.archive', case_id=case.id, contact_id=contact.id) }}">
                                {% else %}
                                <form method="POST" action="{{ url_for('osint.archive_no_case', contact_id=contact.id) }}">
                                {% endif %}
                                    <button type="submit" class="btn btn-warning w-100">
                                        <i class="bi bi-{% if contact.status == 'active' %}archive{% else %}arrow-clockwise{% endif %}"></i>
                                        {% if contact.status == 'active' %}Archivar{% else %}Activar{% endif %}
                                    </button>
                                </form>

                                {% if case %}
                                <form method="POST"
                                      action="{{ url_for('osint.delete', case_id=case.id, contact_id=contact.id) }}"
                                      onsubmit="return confirm('¿Está seguro de eliminar este contacto? Esta acción no se puede deshacer.');">
                                {% else %}
                                <form method="POST"
                                      action="{{ url_for('osint.delete_no_case', contact_id=contact.id) }}"
                                      onsubmit="return confirm('¿Está seguro de eliminar este contacto? Esta acción no se puede deshacer.');">
                                {% endif %}
                                    <button type="submit" class="btn btn-danger w-100">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Creation Info -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-clock-history"></i> Información de Creación
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Creado por:</strong><br>
                                {{ contact.created_by.email }}
                            </p>
                            <p class="mb-2">
                                <strong>Fecha de creación:</strong><br>
                                {{ contact.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            {% if contact.updated_at and contact.updated_at != contact.created_at %}
                            <p class="mb-0">
                                <strong>Última actualización:</strong><br>
                                {{ contact.updated_at.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast for validation results -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="validationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="validationToastTitle">Validación OSINT</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="validationToastBody">
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const validateForm = document.getElementById('validateForm');
    const validateButton = document.getElementById('validateButton');
    const validationToast = new bootstrap.Toast(document.getElementById('validationToast'));

    if (validateForm) {
        validateForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const originalHtml = validateButton.innerHTML;
            validateButton.disabled = true;
            validateButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Validando...';

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                const formData = new FormData(validateForm);

                const headers = {};
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                const response = await fetch(validateForm.action, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                const data = await response.json();

                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');

                if (data.success) {
                    toastTitle.textContent = '✓ Validación Exitosa';
                    toastBody.innerHTML = `<div class="text-success">${data.message}</div>`;
                    validationToast.show();

                    // Reload page after 2 seconds
                    setTimeout(() => location.reload(), 2000);
                } else {
                    toastTitle.textContent = '✗ Error en Validación';
                    toastBody.innerHTML = `<div class="text-danger">${data.error}</div>`;
                    validationToast.show();
                }

            } catch (error) {
                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');
                toastTitle.textContent = '✗ Error';
                toastBody.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
                validationToast.show();
            } finally {
                validateButton.disabled = false;
                validateButton.innerHTML = originalHtml;
            }
        });
    }
});
</script>
{% endblock %}
