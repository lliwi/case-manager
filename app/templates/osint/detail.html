{% extends "base.html" %}

{% block title %}{{ contact.contact_value }} - OSINT{% endblock %}

{% block content %}
{# Detect social media platform #}
{% set contact_lower = contact.contact_value|lower %}
{% set is_instagram = 'instagram.com' in contact_lower or (contact.contact_type == 'username' and not ('x.com' in contact_lower or 'twitter.com' in contact_lower)) %}
{% set is_twitter = 'x.com' in contact_lower or 'twitter.com' in contact_lower %}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="{{ contact.get_type_icon() }}"></i> {{ contact.contact_value }}
                </h2>
                <div>
                    {% if case %}
                        <a href="{{ url_for('osint.edit', case_id=case.id, contact_id=contact.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="{{ url_for('osint.case_contacts', case_id=case.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    {% else %}
                        <a href="{{ url_for('osint.edit_no_case', contact_id=contact.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="{{ url_for('osint.index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <!-- Main Information -->
                <div class="col-lg-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle"></i> Información del Contacto
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Tipo:</strong></div>
                                <div class="col-sm-8">
                                    <i class="{{ contact.get_type_icon() }}"></i>
                                    <span class="badge {{ contact.get_status_badge_class() }}">
                                        {{ contact.contact_type }}
                                    </span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Valor:</strong></div>
                                <div class="col-sm-8"><code>{{ contact.contact_value }}</code></div>
                            </div>

                            {% if contact.name %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Nombre Asociado:</strong></div>
                                <div class="col-sm-8">{{ contact.name }}</div>
                            </div>
                            {% endif %}

                            {% if contact.description %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Descripción:</strong></div>
                                <div class="col-sm-8">{{ contact.description }}</div>
                            </div>
                            {% endif %}

                            {% if contact.source %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Fuente:</strong></div>
                                <div class="col-sm-8">{{ contact.source }}</div>
                            </div>
                            {% endif %}

                            {% if contact.tags %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Etiquetas:</strong></div>
                                <div class="col-sm-8">
                                    {% for tag in contact.get_tags_list() %}
                                        <span class="badge bg-secondary">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Estado:</strong></div>
                                <div class="col-sm-8">
                                    <span class="badge {{ contact.get_status_badge_class() }}">
                                        {{ contact.status }}
                                    </span>
                                </div>
                            </div>

                            {% if contact.case %}
                            <div class="row mb-3">
                                <div class="col-sm-4"><strong>Caso Asociado:</strong></div>
                                <div class="col-sm-8">
                                    <a href="{{ url_for('cases.detail', case_id=contact.case_id) }}">
                                        {{ contact.case.numero_orden }} - {{ contact.case.objeto_investigacion[:50] }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- X (Twitter) Profile Information -->
                    {% if contact.extra_data and contact.extra_data.get('x_profile') %}
                    {% set x_profile = contact.extra_data.x_profile.data %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-twitter-x"></i> Información de Perfil de X (Twitter)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3 text-center">
                                    {% if x_profile.profile_image %}
                                    <img src="{{ x_profile.profile_image }}" alt="{{ x_profile.display_name }}" class="img-fluid rounded-circle mb-2" style="max-width: 120px;">
                                    {% endif %}
                                    <h5>{{ x_profile.display_name }}</h5>
                                    <p class="text-muted">@{{ x_profile.username }}</p>
                                    {% if x_profile.verified %}
                                    <span class="badge bg-primary"><i class="bi bi-patch-check-fill"></i> Verificado</span>
                                    {% endif %}
                                    {% if x_profile.protected %}
                                    <span class="badge bg-warning"><i class="bi bi-lock-fill"></i> Protegido</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-9">
                                    {% if x_profile.bio %}
                                    <p class="mb-3">{{ x_profile.bio }}</p>
                                    {% endif %}

                                    <div class="row mb-2">
                                        <div class="col-md-6">
                                            <strong><i class="bi bi-geo-alt"></i> Ubicación:</strong> {{ x_profile.location or 'No especificada' }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong><i class="bi bi-link-45deg"></i> Sitio web:</strong>
                                            {% if x_profile.website %}
                                            <a href="{{ x_profile.website }}" target="_blank">{{ x_profile.website }}</a>
                                            {% else %}
                                            No especificado
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="row mb-2">
                                        <div class="col-md-12">
                                            <strong><i class="bi bi-calendar"></i> Cuenta creada:</strong> {{ x_profile.created_at }}
                                        </div>
                                    </div>

                                    <!-- Metrics -->
                                    <div class="row mt-3">
                                        <div class="col-md-3 text-center">
                                            <h4>{{ x_profile.metrics.followers_count | default(0) }}</h4>
                                            <small class="text-muted">Seguidores</small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h4>{{ x_profile.metrics.following_count | default(0) }}</h4>
                                            <small class="text-muted">Siguiendo</small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h4>{{ x_profile.metrics.tweet_count | default(0) }}</h4>
                                            <small class="text-muted">Tweets</small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h4>{{ x_profile.metrics.listed_count | default(0) }}</h4>
                                            <small class="text-muted">Listas</small>
                                        </div>
                                    </div>

                                    <!-- Analysis -->
                                    {% if x_profile.summary and x_profile.summary.text %}
                                    <div class="alert alert-info alert-permanent mt-3 mb-0">
                                        <strong><i class="bi bi-graph-up"></i> Análisis:</strong><br>
                                        {{ x_profile.summary.text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-muted small">
                                <i class="bi bi-clock"></i> Datos obtenidos el {{ contact.extra_data.x_profile.fetched_at }}
                                por {{ contact.extra_data.x_profile.fetched_by }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- X (Twitter) Recent Tweets -->
                    {% if contact.extra_data and contact.extra_data.get('x_tweets') %}
                    {% set x_tweets = contact.extra_data.x_tweets.data %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-chat-dots"></i> Últimos Tweets ({{ x_tweets.tweet_count }})
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Timeline Analysis -->
                            {% if x_tweets.timeline_analysis %}
                            <div class="alert alert-light alert-permanent mb-3">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <strong>{{ x_tweets.timeline_analysis.original_tweets }}</strong><br>
                                        <small class="text-muted">Originales</small>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <strong>{{ x_tweets.timeline_analysis.retweets }}</strong><br>
                                        <small class="text-muted">Retweets</small>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <strong>{{ x_tweets.timeline_analysis.replies }}</strong><br>
                                        <small class="text-muted">Respuestas</small>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <strong>{{ x_tweets.timeline_analysis.avg_engagement }}</strong><br>
                                        <small class="text-muted">Engagement Promedio</small>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <strong>Tipo de contenido:</strong> {{ x_tweets.timeline_analysis.content_type | replace('_', ' ') | title }}<br>
                                    <strong>Idioma principal:</strong> {{ x_tweets.timeline_analysis.primary_language }}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Tweets List -->
                            {% for tweet in x_tweets.tweets[:10] %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong>@{{ x_tweets.user.username }}</strong>
                                            <small class="text-muted">{{ tweet.created_at_formatted }}</small>
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ tweet.url }}" target="_blank" class="btn btn-outline-primary">
                                                <i class="bi bi-box-arrow-up-right"></i> Ver en X
                                            </a>
                                            {% if case %}
                                            <button type="button" class="btn btn-outline-success save-tweet-evidence"
                                                    data-tweet-id="{{ tweet.id }}"
                                                    data-tweet-index="{{ loop.index0 }}"
                                                    title="Guardar como evidencia">
                                                <i class="bi bi-shield-check"></i> Guardar
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <p class="mb-2">{{ tweet.text }}</p>

                                    <!-- Tweet Media (Images/Videos) -->
                                    {% if tweet.media %}
                                    <div class="row g-2 mb-3">
                                        {% for media in tweet.media %}
                                        {% if media.type == 'photo' %}
                                        <div class="col-md-6">
                                            <a href="{{ media.url }}" target="_blank" data-lightbox="tweet-{{ tweet.id }}">
                                                <img src="{{ media.url }}" class="img-fluid rounded" alt="{{ media.alt_text or 'Tweet image' }}" style="max-height: 300px; object-fit: cover; width: 100%;">
                                            </a>
                                            {% if media.alt_text %}
                                            <small class="text-muted d-block mt-1">{{ media.alt_text }}</small>
                                            {% endif %}
                                        </div>
                                        {% elif media.type == 'video' or media.type == 'animated_gif' %}
                                        <div class="col-md-6">
                                            <div class="position-relative">
                                                <img src="{{ media.preview_image_url }}" class="img-fluid rounded" alt="Video preview" style="max-height: 300px; object-fit: cover; width: 100%;">
                                                <div class="position-absolute top-50 start-50 translate-middle">
                                                    <span class="badge bg-dark bg-opacity-75 fs-5">
                                                        <i class="bi bi-play-circle"></i> {{ 'GIF' if media.type == 'animated_gif' else 'Video' }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    <!-- Tweet Type Badges -->
                                    <div class="mb-2">
                                        {% if tweet.is_retweet %}
                                        <span class="badge bg-info"><i class="bi bi-arrow-repeat"></i> Retweet</span>
                                        {% endif %}
                                        {% if tweet.is_reply %}
                                        <span class="badge bg-secondary"><i class="bi bi-reply"></i> Respuesta</span>
                                        {% endif %}
                                        {% if tweet.is_quote %}
                                        <span class="badge bg-warning"><i class="bi bi-quote"></i> Quote</span>
                                        {% endif %}
                                        {% if tweet.has_urls %}
                                        <span class="badge bg-light text-dark"><i class="bi bi-link"></i> Con enlaces</span>
                                        {% endif %}
                                        {% if tweet.has_mentions %}
                                        <span class="badge bg-light text-dark"><i class="bi bi-at"></i> Menciones</span>
                                        {% endif %}
                                        {% if tweet.has_hashtags %}
                                        <span class="badge bg-light text-dark"><i class="bi bi-hash"></i> Hashtags</span>
                                        {% endif %}
                                    </div>

                                    <!-- Engagement Metrics -->
                                    <div class="text-muted small">
                                        <i class="bi bi-heart"></i> {{ tweet.metrics_formatted.likes }}
                                        <i class="bi bi-arrow-repeat ms-2"></i> {{ tweet.metrics_formatted.retweets }}
                                        <i class="bi bi-chat ms-2"></i> {{ tweet.metrics_formatted.replies }}
                                        {% if tweet.engagement.engagement_level %}
                                        | <span class="badge bg-{{ 'danger' if tweet.engagement.engagement_level == 'viral' else 'success' if tweet.engagement.engagement_level == 'high' else 'warning' if tweet.engagement.engagement_level == 'medium' else 'secondary' }}">
                                            {{ tweet.engagement.engagement_level | title }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            <div class="text-muted small mt-3">
                                <i class="bi bi-clock"></i> Datos obtenidos el {{ contact.extra_data.x_tweets.fetched_at }}
                                por {{ contact.extra_data.x_tweets.fetched_by }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Instagram Profile Information -->
                    {% if contact.extra_data and contact.extra_data.get('instagram_profile') %}
                    {% set ig_profile = contact.extra_data.instagram_profile.data %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-gradient text-white" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);">
                            <h5 class="mb-0">
                                <i class="bi bi-instagram"></i> Información de Perfil de Instagram
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3 text-center">
                                    {% if ig_profile.profile_pic_url %}
                                    <img src="{{ url_for('osint.image_proxy', url=ig_profile.profile_pic_url) }}" alt="{{ ig_profile.full_name or ig_profile.username }}" class="img-fluid rounded-circle mb-2" style="max-width: 120px;">
                                    {% endif %}
                                    <h5>{{ ig_profile.full_name or ig_profile.username }}</h5>
                                    <p class="text-muted">@{{ ig_profile.username }}</p>
                                    {% if ig_profile.is_verified %}
                                    <span class="badge" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);"><i class="bi bi-patch-check-fill"></i> Verificado</span>
                                    {% endif %}
                                    {% if ig_profile.is_private %}
                                    <span class="badge bg-warning"><i class="bi bi-lock-fill"></i> Privado</span>
                                    {% endif %}
                                    {% if ig_profile.is_business_account %}
                                    <span class="badge bg-info"><i class="bi bi-briefcase"></i> Negocio</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-9">
                                    {% if ig_profile.biography %}
                                    <p class="mb-3">{{ ig_profile.biography }}</p>
                                    {% endif %}

                                    {% if ig_profile.external_url %}
                                    <div class="mb-2">
                                        <strong><i class="bi bi-link-45deg"></i> Enlace externo:</strong>
                                        <a href="{{ ig_profile.external_url }}" target="_blank">{{ ig_profile.external_url }}</a>
                                    </div>
                                    {% endif %}

                                    {% if ig_profile.category_name %}
                                    <div class="mb-2">
                                        <strong><i class="bi bi-tag"></i> Categoría:</strong> {{ ig_profile.category_name }}
                                    </div>
                                    {% endif %}

                                    <!-- Metrics -->
                                    <div class="row mt-3">
                                        <div class="col-md-3 text-center">
                                            <h4>{{ ig_profile.followers_count | default(0) }}</h4>
                                            <small class="text-muted">Seguidores</small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h4>{{ ig_profile.following_count | default(0) }}</h4>
                                            <small class="text-muted">Siguiendo</small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h4>{{ ig_profile.posts_count | default(0) }}</h4>
                                            <small class="text-muted">Posts</small>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <h4>{{ ig_profile.follower_ratio | default(0) }}</h4>
                                            <small class="text-muted">Ratio Seguidores</small>
                                        </div>
                                    </div>

                                    <!-- Analysis -->
                                    {% if ig_profile.summary and ig_profile.summary.text %}
                                    <div class="alert alert-info alert-permanent mt-3 mb-0">
                                        <strong><i class="bi bi-graph-up"></i> Análisis de Perfil:</strong><br>
                                        {{ ig_profile.summary.text }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-muted small">
                                <i class="bi bi-clock"></i> Datos obtenidos el {{ contact.extra_data.instagram_profile.fetched_at }}
                                por {{ contact.extra_data.instagram_profile.fetched_by }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Instagram Posts -->
                    {% if contact.extra_data and contact.extra_data.get('instagram_posts') %}
                    {% set ig_posts = contact.extra_data.instagram_posts.data %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header text-white" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);">
                            <h5 class="mb-0">
                                <i class="bi bi-images"></i> Posts de Instagram ({{ ig_posts.post_count }})
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Posts Analysis -->
                            {% if ig_posts.posts_analysis %}
                            <div class="alert alert-light alert-permanent mb-3">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <strong>{{ ig_posts.posts_analysis.post_types.images }}</strong><br>
                                        <small class="text-muted">Imágenes</small>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <strong>{{ ig_posts.posts_analysis.post_types.videos }}</strong><br>
                                        <small class="text-muted">Videos</small>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <strong>{{ ig_posts.posts_analysis.post_types.carousels }}</strong><br>
                                        <small class="text-muted">Carruseles</small>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <strong>{{ ig_posts.posts_analysis.avg_engagement }}</strong><br>
                                        <small class="text-muted">Engagement Promedio</small>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <strong>Tipo de contenido:</strong> {{ ig_posts.posts_analysis.content_type | replace('_', ' ') | title }}<br>
                                    <strong>Total likes:</strong> {{ ig_posts.posts_analysis.total_likes }}<br>
                                    <strong>Total comentarios:</strong> {{ ig_posts.posts_analysis.total_comments }}
                                    {% if ig_posts.posts_analysis.top_hashtags %}
                                    <br><strong>Top hashtags:</strong> {{ ig_posts.posts_analysis.top_hashtags | join(', ') }}
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Posts Grid -->
                            <div class="row g-3">
                                {% for post in ig_posts.posts[:12] %}
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <!-- Post Image/Video -->
                                        {% if post.display_url %}
                                        <a href="{{ post.url }}" target="_blank">
                                            <img src="{{ url_for('osint.image_proxy', url=post.display_url) }}" class="card-img-top" alt="Instagram post" style="max-height: 250px; object-fit: cover;">
                                        </a>
                                        {% endif %}

                                        <!-- Post Type Badge -->
                                        <div class="position-absolute top-0 end-0 m-2">
                                            {% if post.has_video %}
                                            <span class="badge bg-danger"><i class="bi bi-play-circle"></i> Video</span>
                                            {% elif post.is_carousel %}
                                            <span class="badge bg-info"><i class="bi bi-images"></i> Carrusel ({{ post.carousel_count }})</span>
                                            {% else %}
                                            <span class="badge bg-primary"><i class="bi bi-image"></i> Imagen</span>
                                            {% endif %}
                                        </div>

                                        <div class="card-body">
                                            <!-- Caption -->
                                            {% if post.caption %}
                                            <p class="card-text small" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                                {{ post.caption[:150] }}{% if post.caption|length > 150 %}...{% endif %}
                                            </p>
                                            {% endif %}

                                            <!-- Hashtags -->
                                            {% if post.hashtags %}
                                            <div class="mb-2">
                                                {% for hashtag in post.hashtags[:3] %}
                                                <span class="badge bg-light text-dark">#{{ hashtag }}</span>
                                                {% endfor %}
                                                {% if post.hashtags|length > 3 %}
                                                <span class="badge bg-light text-dark">+{{ post.hashtags|length - 3 }}</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}

                                            <!-- Engagement Metrics -->
                                            <div class="d-flex justify-content-between text-muted small mb-2">
                                                <span><i class="bi bi-heart-fill text-danger"></i> {{ post.likes_count }}</span>
                                                <span><i class="bi bi-chat-fill text-primary"></i> {{ post.comments_count }}</span>
                                                {% if post.location %}
                                                <span><i class="bi bi-geo-alt-fill text-success"></i> {{ post.location.name }}</span>
                                                {% endif %}
                                            </div>

                                            <!-- Date -->
                                            <div class="text-muted small">
                                                <i class="bi bi-clock"></i> {{ post.timestamp_formatted }}
                                            </div>

                                            <!-- Actions -->
                                            <div class="d-grid gap-1 mt-2">
                                                <a href="{{ post.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-box-arrow-up-right"></i> Ver en Instagram
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="text-muted small mt-3">
                                <i class="bi bi-clock"></i> Datos obtenidos el {{ contact.extra_data.instagram_posts.fetched_at }}
                                por {{ contact.extra_data.instagram_posts.fetched_by }}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Validation Status -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-shield-check"></i> Estado de Validación
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if contact.is_validated %}
                                <div class="alert alert-success">
                                    <h6><i class="bi bi-check-circle"></i> Contacto Validado</h6>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <strong>Fecha de Validación:</strong><br>
                                            {{ contact.validation_date.strftime('%d/%m/%Y %H:%M') }}
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Puntuación de Fraude:</strong><br>
                                            <span class="badge {{ contact.get_risk_badge_class() }} fs-5">
                                                {{ contact.fraud_score }}/100
                                            </span>
                                            ({{ contact.risk_level }})
                                        </div>
                                    </div>

                                    {% if contact.validation_result %}
                                    <div class="mt-3">
                                        <strong>Resumen:</strong><br>
                                        {{ contact.validation_result.get_summary().recommendation }}
                                    </div>

                                    <div class="mt-3">
                                        <a href="{{ url_for('osint.validation_detail', validation_id=contact.validation_result.id) }}"
                                           class="btn btn-sm btn-outline-info">
                                            <i class="bi bi-eye"></i> Ver Detalles Completos
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <h6><i class="bi bi-exclamation-triangle"></i> Contacto Sin Validar</h6>
                                    <p class="mb-0">
                                        {% if contact.contact_type in ['email', 'phone'] %}
                                            Este contacto aún no ha sido validado con IPQualityScore.
                                            Usa el botón "Validar con IPQualityScore" en la sección de acciones.
                                        {% else %}
                                            Este tipo de contacto no puede ser validado automáticamente.
                                        {% endif %}
                                    </p>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Validation History -->
                    {% if validations %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-clock-history"></i> Historial de Validaciones
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Puntuación</th>
                                            <th>Riesgo</th>
                                            <th>Validado Por</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for validation in validations %}
                                        <tr>
                                            <td>{{ validation.validation_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                            <td>
                                                <span class="badge {{ validation.get_risk_badge_class() }}">
                                                    {{ validation.fraud_score }}/100
                                                </span>
                                            </td>
                                            <td>{{ validation.risk_level }}</td>
                                            <td>{{ validation.validated_by.email }}</td>
                                            <td>
                                                <a href="{{ url_for('osint.validation_detail', validation_id=validation.id) }}"
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="bi bi-eye"></i> Ver
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Actions -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i class="bi bi-lightning"></i> Acciones
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                {% if contact.contact_type in ['email', 'phone'] %}
                                {% if case %}
                                <form method="POST" action="{{ url_for('osint.validate_contact', case_id=case.id, contact_id=contact.id) }}" id="validateForm">
                                {% else %}
                                <form method="POST" action="{{ url_for('osint.validate_contact_no_case', contact_id=contact.id) }}" id="validateForm">
                                {% endif %}
                                    {{ validate_form.hidden_tag() }}
                                    {{ validate_form.contact_id }}
                                    {{ validate_form.notes(class="form-control mb-2", placeholder="Notas opcionales...") }}
                                    <button type="submit" class="btn btn-success w-100" id="validateButton">
                                        <i class="bi bi-lightning-charge"></i> Validar con IPQualityScore
                                    </button>
                                </form>
                                {% endif %}

                                {% if contact.contact_type in ['social_profile', 'username'] %}
                                    {% if is_twitter %}
                                    <!-- X API Profile Lookup -->
                                    {% if case %}
                                    <form method="POST" action="{{ url_for('osint.x_profile_lookup', case_id=case.id, contact_id=contact.id) }}" class="x-api-form">
                                    {% else %}
                                    <form method="POST" action="{{ url_for('osint.x_profile_lookup_no_case', contact_id=contact.id) }}" class="x-api-form">
                                    {% endif %}
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-info w-100">
                                            <i class="bi bi-person-circle"></i> Obtener Perfil de X (Twitter)
                                        </button>
                                    </form>

                                    <!-- X API Tweets Lookup -->
                                    {% if case %}
                                    <form method="POST" action="{{ url_for('osint.x_tweets_lookup', case_id=case.id, contact_id=contact.id) }}" class="x-api-form">
                                    {% else %}
                                    <form method="POST" action="{{ url_for('osint.x_tweets_lookup_no_case', contact_id=contact.id) }}" class="x-api-form">
                                    {% endif %}
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="number" name="max_results" class="form-control mb-2" placeholder="Número de tweets (5-100)" value="10" min="5" max="100">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-chat-dots"></i> Obtener Últimos Tweets
                                        </button>
                                    </form>
                                    {% endif %}

                                    {% if is_instagram %}
                                    <!-- Instagram API Profile Lookup -->
                                    {% if case %}
                                    <form method="POST" action="{{ url_for('osint.instagram_profile_lookup', case_id=case.id, contact_id=contact.id) }}" class="instagram-api-form">
                                    {% else %}
                                    <form method="POST" action="{{ url_for('osint.instagram_profile_lookup_no_case', contact_id=contact.id) }}" class="instagram-api-form">
                                    {% endif %}
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="btn btn-info w-100">
                                            <i class="bi bi-instagram"></i> Obtener Perfil de Instagram
                                        </button>
                                    </form>

                                    <!-- Instagram API Posts Lookup -->
                                    {% if case %}
                                    <form method="POST" action="{{ url_for('osint.instagram_posts_lookup', case_id=case.id, contact_id=contact.id) }}" class="instagram-api-form">
                                    {% else %}
                                    <form method="POST" action="{{ url_for('osint.instagram_posts_lookup_no_case', contact_id=contact.id) }}" class="instagram-api-form">
                                    {% endif %}
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="number" name="max_posts" class="form-control mb-2" placeholder="Número de posts (1-50)" value="12" min="1" max="50">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-images"></i> Obtener Últimos Posts
                                        </button>
                                    </form>
                                    {% endif %}
                                {% endif %}

                                {% if case %}
                                <form method="POST" action="{{ url_for('osint.archive', case_id=case.id, contact_id=contact.id) }}">
                                {% else %}
                                <form method="POST" action="{{ url_for('osint.archive_no_case', contact_id=contact.id) }}">
                                {% endif %}
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-warning w-100">
                                        <i class="bi bi-{% if contact.status == 'active' %}archive{% else %}arrow-clockwise{% endif %}"></i>
                                        {% if contact.status == 'active' %}Archivar{% else %}Activar{% endif %}
                                    </button>
                                </form>

                                {% if case %}
                                <form method="POST"
                                      action="{{ url_for('osint.delete', case_id=case.id, contact_id=contact.id) }}"
                                      onsubmit="return confirm('¿Está seguro de eliminar este contacto? Esta acción no se puede deshacer.');">
                                {% else %}
                                <form method="POST"
                                      action="{{ url_for('osint.delete_no_case', contact_id=contact.id) }}"
                                      onsubmit="return confirm('¿Está seguro de eliminar este contacto? Esta acción no se puede deshacer.');">
                                {% endif %}
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger w-100">
                                        <i class="bi bi-trash"></i> Eliminar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Creation Info -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-clock-history"></i> Información de Creación
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">
                                <strong>Creado por:</strong><br>
                                {{ contact.created_by.email }}
                            </p>
                            <p class="mb-2">
                                <strong>Fecha de creación:</strong><br>
                                {{ contact.created_at.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            {% if contact.updated_at and contact.updated_at != contact.created_at %}
                            <p class="mb-0">
                                <strong>Última actualización:</strong><br>
                                {{ contact.updated_at.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast for validation results -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="validationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="validationToastTitle">Validación OSINT</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="validationToastBody">
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const validateForm = document.getElementById('validateForm');
    const validateButton = document.getElementById('validateButton');
    const validationToast = new bootstrap.Toast(document.getElementById('validationToast'));

    if (validateForm) {
        validateForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const originalHtml = validateButton.innerHTML;
            validateButton.disabled = true;
            validateButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Validando...';

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                const formData = new FormData(validateForm);

                const headers = {};
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                const response = await fetch(validateForm.action, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                const data = await response.json();

                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');

                if (data.success) {
                    toastTitle.textContent = '✓ Validación Exitosa';
                    toastBody.innerHTML = `<div class="text-success">${data.message}</div>`;
                    validationToast.show();

                    // Reload page after 2 seconds
                    setTimeout(() => location.reload(), 2000);
                } else {
                    toastTitle.textContent = '✗ Error en Validación';
                    toastBody.innerHTML = `<div class="text-danger">${data.error}</div>`;
                    validationToast.show();
                }

            } catch (error) {
                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');
                toastTitle.textContent = '✗ Error';
                toastBody.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
                validationToast.show();
            } finally {
                validateButton.disabled = false;
                validateButton.innerHTML = originalHtml;
            }
        });
    }

    // Handle X API forms (profile and tweets)
    const xApiForms = document.querySelectorAll('.x-api-form');

    xApiForms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = form.querySelector('button[type="submit"]');
            const originalHtml = submitButton.innerHTML;

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                const formData = new FormData(form);

                const headers = {};
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                const data = await response.json();

                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');

                if (data.success) {
                    toastTitle.textContent = '✓ Operación Exitosa';
                    toastBody.innerHTML = `<div class="text-success">${data.message}</div>`;
                    validationToast.show();

                    // Reload page after 2 seconds to show new data
                    setTimeout(() => location.reload(), 2000);
                } else {
                    // Check if error is rate limit related
                    const errorMsg = data.error || 'Error al procesar la solicitud';
                    const isRateLimit = errorMsg.includes('Rate limit') || errorMsg.includes('límite');

                    toastTitle.textContent = isRateLimit ? '⏱️ Límite de Peticiones Alcanzado' : '✗ Error';

                    let errorHtml = `<div class="text-${isRateLimit ? 'warning' : 'danger'}">`;
                    errorHtml += `<strong>${errorMsg}</strong>`;
                    if (isRateLimit) {
                        errorHtml += `<br><small class="text-muted">La API de X limita el número de consultas por ventana de tiempo.</small>`;
                    }
                    errorHtml += `</div>`;

                    toastBody.innerHTML = errorHtml;
                    validationToast.show();
                }

            } catch (error) {
                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');
                toastTitle.textContent = '✗ Error';
                toastBody.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
                validationToast.show();
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalHtml;
            }
        });
    });

    // Handle Instagram API forms (profile and posts)
    const instagramApiForms = document.querySelectorAll('.instagram-api-form');

    instagramApiForms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = form.querySelector('button[type="submit"]');
            const originalHtml = submitButton.innerHTML;

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                const formData = new FormData(form);

                const headers = {};
                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                const response = await fetch(form.action, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                const data = await response.json();

                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');

                if (data.success) {
                    toastTitle.textContent = '✓ Operación Exitosa';
                    toastBody.innerHTML = `<div class="text-success">${data.message}</div>`;
                    validationToast.show();

                    // Reload page after 2 seconds to show new data
                    setTimeout(() => location.reload(), 2000);
                } else {
                    toastTitle.textContent = '✗ Error';
                    toastBody.innerHTML = `<div class="text-danger">${data.error || 'Error al procesar la solicitud'}</div>`;
                    validationToast.show();
                }

            } catch (error) {
                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');
                toastTitle.textContent = '✗ Error';
                toastBody.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
                validationToast.show();
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = originalHtml;
            }
        });
    });

    // Handle save tweet as evidence
    const saveTweetButtons = document.querySelectorAll('.save-tweet-evidence');

    saveTweetButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const tweetId = this.getAttribute('data-tweet-id');
            const tweetIndex = this.getAttribute('data-tweet-index');
            const originalHtml = this.innerHTML;

            // Show loading state
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

                const headers = {
                    'Content-Type': 'application/json',
                };

                if (csrfToken) {
                    headers['X-CSRFToken'] = csrfToken;
                }

                const response = await fetch(window.location.pathname + '/save-tweet-evidence', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        tweet_index: parseInt(tweetIndex)
                    })
                });

                const data = await response.json();

                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');

                if (data.success) {
                    toastTitle.textContent = '✓ Evidencia Guardada';
                    toastBody.innerHTML = `<div class="text-success">${data.message}</div>`;
                    validationToast.show();

                    // Change button to indicate it's saved
                    this.classList.remove('btn-outline-success');
                    this.classList.add('btn-success');
                    this.innerHTML = '<i class="bi bi-check-circle"></i> Guardado';
                    this.disabled = true;
                } else {
                    toastTitle.textContent = '✗ Error';
                    toastBody.innerHTML = `<div class="text-danger">${data.error}</div>`;
                    validationToast.show();
                    this.disabled = false;
                    this.innerHTML = originalHtml;
                }

            } catch (error) {
                const toastTitle = document.getElementById('validationToastTitle');
                const toastBody = document.getElementById('validationToastBody');
                toastTitle.textContent = '✗ Error';
                toastBody.innerHTML = `<div class="text-danger">Error: ${error.message}</div>`;
                validationToast.show();
                this.disabled = false;
                this.innerHTML = originalHtml;
            }
        });
    });
});
</script>
{% endblock %}
