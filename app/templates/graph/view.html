{% extends "base.html" %}

{% block title %}Grafo de Relaciones - Caso {{ case.numero_orden }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h4 mb-0">Grafo de Relaciones</h1>
        <small class="text-muted">Caso: {{ case.numero_orden }} - {{ case.cliente_nombre }}</small>
    </div>
    <div>
        <a href="{{ url_for('cases.detail', case_id=case.id) }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left"></i> Volver al Caso
        </a>
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-plus-circle"></i> Nuevo Nodo
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='PERSON') }}">
                    <i class="bi bi-person"></i> Persona
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='COMPANY') }}">
                    <i class="bi bi-building"></i> Empresa
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='VEHICLE') }}">
                    <i class="bi bi-car-front"></i> Vehículo
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='PHONE') }}">
                    <i class="bi bi-telephone"></i> Teléfono
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='EMAIL') }}">
                    <i class="bi bi-envelope"></i> Email
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='ADDRESS') }}">
                    <i class="bi bi-geo-alt"></i> Dirección
                </a></li>
            </ul>
        </div>
        <a href="{{ url_for('graph.create_relationship', case_id=case.id) }}" class="btn btn-success">
            <i class="bi bi-arrows-angle-contract"></i> Nueva Relación
        </a>
    </div>
</div>

<!-- Graph Visualization -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-diagram-3"></i> Visualización de Red</h6>
    </div>
    <div class="card-body">
        <div id="graph-container" style="height: 600px; border: 1px solid #dee2e6; border-radius: 4px;">
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center text-muted">
                    <i class="bi bi-diagram-3 display-1"></i>
                    <p class="mt-3">Grafo de Relaciones</p>
                    <small>El grafo se cargará aquí usando Cytoscape.js o Vis.js</small>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer bg-white">
        <div class="row">
            <div class="col-md-4">
                <strong>Nodos:</strong> <span id="node-count">{{ nodes|length if nodes else 0 }}</span>
            </div>
            <div class="col-md-4">
                <strong>Relaciones:</strong> <span id="relationship-count">{{ relationships|length if relationships else 0 }}</span>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-sm btn-outline-secondary" onclick="resetGraph()">
                    <i class="bi bi-arrow-clockwise"></i> Reiniciar Vista
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Node List -->
<div class="row">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-circle"></i> Nodos ({{ nodes|length if nodes else 0 }})</h6>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if nodes %}
                    <div class="list-group">
                        {% for node in nodes %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ node.label }}</strong>
                                    <br><small class="text-muted">{{ node.node_type }}</small>
                                </div>
                                <form method="POST" action="{{ url_for('graph.delete_node', node_id=node.id) }}" class="d-inline"
                                      onsubmit="return confirm('¿Eliminar nodo?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center mb-0">No hay nodos creados</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-arrows-angle-contract"></i> Relaciones ({{ relationships|length if relationships else 0 }})</h6>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if relationships %}
                    <div class="list-group">
                        {% for rel in relationships %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ rel.source_label }} → {{ rel.target_label }}</strong>
                                    <br><small class="text-muted">{{ rel.relationship_type }}</small>
                                </div>
                                <form method="POST" action="{{ url_for('graph.delete_relationship', relationship_id=rel.id) }}" class="d-inline"
                                      onsubmit="return confirm('¿Eliminar relación?')">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center mb-0">No hay relaciones creadas</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function resetGraph() {
    // Placeholder for graph reset functionality
    alert('Funcionalidad de reinicio de grafo (implementar con librería de visualización)');
}
</script>
{% endblock %}
