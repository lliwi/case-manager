{% extends "base.html" %}

{% block title %}Grafo de Relaciones - Caso {{ case.numero_orden }}{% endblock %}

{% block extra_css %}
<!-- Local vis-network CSS -->
<link href="{{ url_for('static', filename='vendor/vis-network/vis-network.min.css') }}" rel="stylesheet" type="text/css">
<style>
    #graph-container {
        height: 600px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: #fafafa;
    }
    .graph-legend {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 8px;
    }
    /* Custom badge colors */
    .bg-purple {
        background-color: #9b59b6 !important;
        color: white;
    }
    .bg-orange {
        background-color: #e67e22 !important;
        color: white;
    }
    .bg-teal {
        background-color: #16a085 !important;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h4 mb-0">Grafo de Relaciones</h1>
        <small class="text-muted">Caso: {{ case.numero_orden }} - {{ case.cliente_nombre }}</small>
    </div>
    <div>
        <a href="{{ url_for('cases.detail', case_id=case.id) }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left"></i> Volver al Caso
        </a>
        <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-plus-circle"></i> Nuevo Nodo
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='person') }}">
                    <i class="bi bi-person"></i> Persona
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='company') }}">
                    <i class="bi bi-building"></i> Empresa
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='vehicle') }}">
                    <i class="bi bi-car-front"></i> Vehículo
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='phone') }}">
                    <i class="bi bi-telephone"></i> Teléfono
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='email') }}">
                    <i class="bi bi-envelope"></i> Email
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='address') }}">
                    <i class="bi bi-geo-alt"></i> Dirección
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('graph.create_node', case_id=case.id, node_type='social') }}">
                    <i class="bi bi-share"></i> Perfil Social
                </a></li>
            </ul>
        </div>
        <a href="{{ url_for('graph.create_relationship', case_id=case.id) }}" class="btn btn-success">
            <i class="bi bi-arrows-angle-contract"></i> Nueva Relación
        </a>
        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#importElementsModal" onclick="loadCaseElements()">
            <i class="bi bi-box-arrow-in-down"></i> Importar desde Caso
        </button>
    </div>
</div>

<!-- Graph Visualization -->
<div class="card shadow mb-4">
    <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-diagram-3"></i> Visualización de Red</h6>
    </div>
    <div class="card-body position-relative">
        <div id="graph-container">
            <div id="graph-loading" class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center text-muted">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando grafo...</p>
                </div>
            </div>
        </div>
        <!-- Legend -->
        <div class="graph-legend" id="graph-legend" style="display: none;">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>Persona</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span>Empresa</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2ecc71;"></div>
                <span>Teléfono</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f39c12;"></div>
                <span>Email</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #9b59b6;"></div>
                <span>Vehículo</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #1abc9c;"></div>
                <span>Dirección</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e67e22;"></div>
                <span>Perfil Social</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #34495e;"></div>
                <span>Evidencia</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #16a085;"></div>
                <span>Contacto OSINT</span>
            </div>
        </div>
    </div>
    <div class="card-footer bg-white">
        <div class="row">
            <div class="col-md-4">
                <strong>Nodos:</strong> <span id="node-count">0</span>
            </div>
            <div class="col-md-4">
                <strong>Relaciones:</strong> <span id="relationship-count">0</span>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-sm btn-outline-success" id="save-layout-button" title="Guardar posiciones actuales de los nodos">
                    <i class="bi bi-save"></i> Guardar Layout
                </button>
                <button class="btn btn-sm btn-outline-danger" id="reset-layout-button" title="Resetear a disposición automática">
                    <i class="bi bi-arrow-counterclockwise"></i> Resetear Layout
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="resetGraph()">
                    <i class="bi bi-arrow-clockwise"></i> Reiniciar Vista
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="reloadGraph()">
                    <i class="bi bi-arrow-repeat"></i> Recargar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics -->
<div class="row">
    <div class="col-md-3">
        <div class="card shadow">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.total_nodes }}</h3>
                <small class="text-muted">Total Nodos</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ stats.total_relationships }}</h3>
                <small class="text-muted">Total Relaciones</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-body">
                <h6 class="mb-2">Tipos de Nodos:</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for node_type, count in stats.node_types.items() %}
                        <span class="badge bg-secondary">{{ node_type }}: {{ count }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Node Details Modal -->
<div class="modal fade" id="nodeDetailsModal" tabindex="-1" aria-labelledby="nodeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nodeDetailsModalLabel">
                    <i class="bi bi-info-circle"></i> Detalles del Nodo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Node Type Badge -->
                <div class="mb-3">
                    <span class="badge fs-6" id="node-type-badge">Tipo</span>
                    <span class="text-muted ms-2" id="node-id-display"></span>
                </div>

                <!-- View Mode -->
                <div id="node-view-mode">
                    <table class="table table-bordered">
                        <tbody id="node-properties-table">
                            <!-- Properties will be populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Edit Mode -->
                <div id="node-edit-mode" style="display: none;">
                    <form id="node-edit-form">
                        <div id="node-edit-fields">
                            <!-- Edit fields will be populated dynamically -->
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <!-- View Mode Buttons -->
                <div id="node-view-buttons">
                    <button type="button" class="btn btn-outline-primary" onclick="enterEditMode()">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteNode()">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
                <!-- Edit Mode Buttons -->
                <div id="node-edit-buttons" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary" onclick="cancelEditMode()">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveNodeChanges()">
                        <i class="bi bi-check-lg"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteNodeModal" tabindex="-1" aria-labelledby="deleteNodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteNodeModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar el nodo <strong id="delete-node-label"></strong>?</p>
                <p class="text-danger mb-0">
                    <i class="bi bi-exclamation-circle"></i>
                    Esta acción también eliminará todas las relaciones conectadas a este nodo y no se puede deshacer.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="executeDeleteNode()">
                    <i class="bi bi-trash"></i> Eliminar Nodo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Relationship Details Modal -->
<div class="modal fade" id="relationshipDetailsModal" tabindex="-1" aria-labelledby="relationshipDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="relationshipDetailsModalLabel">
                    <i class="bi bi-arrows-angle-contract"></i> Detalles de la Relación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Relationship Type Badge -->
                <div class="mb-3">
                    <span class="badge bg-secondary fs-6" id="rel-type-badge">Tipo</span>
                    <span class="text-muted ms-2" id="rel-id-display"></span>
                </div>

                <!-- Connection Info -->
                <div class="alert alert-light mb-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <span class="badge bg-primary me-2" id="rel-from-label">Origen</span>
                        <i class="bi bi-arrow-right mx-2"></i>
                        <span class="badge bg-success" id="rel-to-label">Destino</span>
                    </div>
                </div>

                <!-- View Mode -->
                <div id="rel-view-mode">
                    <table class="table table-bordered">
                        <tbody id="rel-properties-table">
                            <!-- Properties will be populated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Edit Mode -->
                <div id="rel-edit-mode" style="display: none;">
                    <form id="rel-edit-form">
                        <div class="mb-3">
                            <label class="form-label" for="edit-rel-confidence">Confianza (0-100%)</label>
                            <input type="range" class="form-range" id="edit-rel-confidence" name="confidence" min="0" max="1" step="0.1">
                            <div class="text-center"><span id="confidence-value">100</span>%</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="edit-rel-start_date">Fecha de Inicio</label>
                            <input type="date" class="form-control" id="edit-rel-start_date" name="start_date">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="edit-rel-end_date">Fecha de Fin</label>
                            <input type="date" class="form-control" id="edit-rel-end_date" name="end_date">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="edit-rel-notes">Notas</label>
                            <textarea class="form-control" id="edit-rel-notes" name="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <!-- View Mode Buttons -->
                <div id="rel-view-buttons">
                    <button type="button" class="btn btn-outline-primary" onclick="enterRelEditMode()">
                        <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="confirmDeleteRelationship()">
                        <i class="bi bi-trash"></i> Eliminar
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
                <!-- Edit Mode Buttons -->
                <div id="rel-edit-buttons" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary" onclick="cancelRelEditMode()">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveRelationshipChanges()">
                        <i class="bi bi-check-lg"></i> Guardar Cambios
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Relationship Confirmation Modal -->
<div class="modal fade" id="deleteRelationshipModal" tabindex="-1" aria-labelledby="deleteRelationshipModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteRelationshipModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación de Relación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar la relación <strong id="delete-rel-label"></strong>?</p>
                <p class="text-muted mb-0">
                    <i class="bi bi-info-circle"></i>
                    Esta acción eliminará la conexión entre los dos nodos pero no eliminará los nodos en sí.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="executeDeleteRelationship()">
                    <i class="bi bi-trash"></i> Eliminar Relación
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Elements Modal -->
<div class="modal fade" id="importElementsModal" tabindex="-1" aria-labelledby="importElementsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importElementsModalLabel">
                    <i class="bi bi-box-arrow-in-down"></i> Importar Elementos del Caso al Grafo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="importTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="evidencias-tab" data-bs-toggle="tab" data-bs-target="#evidencias-panel" type="button" role="tab">
                            <i class="bi bi-file-earmark-text"></i> Evidencias
                            <span class="badge bg-secondary ms-1" id="evidencias-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="contactos-tab" data-bs-toggle="tab" data-bs-target="#contactos-panel" type="button" role="tab">
                            <i class="bi bi-person-lines-fill"></i> Contactos OSINT
                            <span class="badge bg-secondary ms-1" id="contactos-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sujetos-tab" data-bs-toggle="tab" data-bs-target="#sujetos-panel" type="button" role="tab">
                            <i class="bi bi-people"></i> Sujetos
                            <span class="badge bg-secondary ms-1" id="sujetos-count">0</span>
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3" id="importTabsContent">
                    <!-- Evidencias Tab -->
                    <div class="tab-pane fade show active" id="evidencias-panel" role="tabpanel">
                        <div id="evidencias-loading" class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="ms-2">Cargando evidencias...</span>
                        </div>
                        <div id="evidencias-list" class="list-group" style="display: none;"></div>
                        <div id="evidencias-empty" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">No hay evidencias en este caso</p>
                        </div>
                    </div>

                    <!-- Contactos OSINT Tab -->
                    <div class="tab-pane fade" id="contactos-panel" role="tabpanel">
                        <div id="contactos-loading" class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="ms-2">Cargando contactos...</span>
                        </div>
                        <div id="contactos-list" class="list-group" style="display: none;"></div>
                        <div id="contactos-empty" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">No hay contactos OSINT en este caso</p>
                        </div>
                    </div>

                    <!-- Sujetos Tab -->
                    <div class="tab-pane fade" id="sujetos-panel" role="tabpanel">
                        <div id="sujetos-loading" class="text-center py-4">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <span class="ms-2">Cargando sujetos...</span>
                        </div>
                        <div id="sujetos-list" class="list-group" style="display: none;"></div>
                        <div id="sujetos-empty" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">No hay sujetos definidos en este caso</p>
                        </div>
                    </div>
                </div>

                <!-- Selection Summary -->
                <div class="mt-3 p-3 bg-light rounded" id="selection-summary" style="display: none;">
                    <strong><i class="bi bi-check2-square"></i> Seleccionados:</strong>
                    <span id="selected-count">0</span> elementos
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="selectAllElements()">
                    <i class="bi bi-check-all"></i> Seleccionar Todo
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="deselectAllElements()">
                    <i class="bi bi-x-lg"></i> Deseleccionar Todo
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="importSelectedElements()" id="btn-import" disabled>
                    <i class="bi bi-plus-circle"></i> Crear Nodos (<span id="import-count">0</span>)
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Local vis-network JavaScript -->
<script src="{{ url_for('static', filename='vendor/vis-network/vis-network.min.js') }}"></script>
<script>
let network = null;
let allData = null;
let savedPositions = {};
let hasSavedLayout = false;
// Load saved layout positions
async function loadSavedLayout() {
    try {
        const response = await fetch('/graph/api/case/{{ case.id }}/layout');
        const data = await response.json();
        if (data.positions && Object.keys(data.positions).length > 0) {
            savedPositions = data.positions;
            hasSavedLayout = true;
        }
    } catch (e) {
        console.warn('[Layout] No se pudieron cargar posiciones guardadas:', e);
    }
}

// Save all current positions to server
async function saveAllPositions() {
    if (!network) return;
    const positions = network.getPositions();
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const response = await fetch('/graph/api/case/{{ case.id }}/layout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ positions: positions })
        });
        const result = await response.json();
        if (result.success) {
            savedPositions = positions;
            hasSavedLayout = true;
        }
        return result;
    } catch (e) {
        console.error('[Layout] Error al guardar layout:', e);
    }
}

// Load graph data
async function loadGraphData() {
    console.log('[Graph] Starting to load graph data...');
    try {
        // Load saved positions first
        await loadSavedLayout();

        const url = '{{ url_for("graph.api_graph_data", case_id=case.id) }}';
        console.log('[Graph] Fetching from:', url);

        const response = await fetch(url);
        console.log('[Graph] Response status:', response.status);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('[Graph] Data received:', data);
        console.log('[Graph] Nodes count:', data.nodes ? data.nodes.length : 0);
        console.log('[Graph] Edges count:', data.edges ? data.edges.length : 0);

        allData = data;

        if (!data.nodes || data.nodes.length === 0) {
            document.getElementById('graph-loading').innerHTML = `
                <div class="text-center text-muted">
                    <i class="bi bi-diagram-3 display-1"></i>
                    <p class="mt-3">No hay nodos en este grafo</p>
                    <small>Crea nodos usando el botón "Nuevo Nodo" arriba</small>
                </div>
            `;
            updateCounts(data);
            return;
        }

        renderGraph(data);
        updateCounts(data);

        // Show legend if there are nodes
        if (data.nodes.length > 0) {
            document.getElementById('graph-legend').style.display = 'block';
        }

        console.log('[Graph] Graph rendered successfully');
    } catch (error) {
        console.error('[Graph] Error loading graph:', error);
        document.getElementById('graph-loading').innerHTML = `
            <div class="text-center text-danger">
                <i class="bi bi-exclamation-triangle display-1"></i>
                <p class="mt-3">Error al cargar el grafo</p>
                <small>${error.message}</small>
                <br><small class="text-muted">Revisa la consola del navegador para más detalles</small>
            </div>
        `;
    }
}

// Render graph with vis.js
function renderGraph(data) {
    console.log('[Graph] Rendering graph...');
    const container = document.getElementById('graph-container');
    console.log('[Graph] Container:', container);

    // Hide loading
    const loading = document.getElementById('graph-loading');
    if (loading) {
        loading.style.display = 'none';
        console.log('[Graph] Loading indicator hidden');
    }

    // Apply saved positions to nodes
    if (hasSavedLayout) {
        data.nodes.forEach(node => {
            const pos = savedPositions[String(node.id)];
            if (pos) {
                node.x = pos.x;
                node.y = pos.y;
                node.fixed = { x: true, y: true };
            }
        });
    }

    // Configure nodes dataset
    console.log('[Graph] Creating vis.DataSet with nodes:', data.nodes.length);
    const nodes = new vis.DataSet(data.nodes);
    console.log('[Graph] Creating vis.DataSet with edges:', data.edges.length);
    const edges = new vis.DataSet(data.edges);

    const graphData = {
        nodes: nodes,
        edges: edges
    };
    console.log('[Graph] Graph data prepared:', graphData);

    // Configure options
    const options = {
        nodes: {
            shape: 'dot',
            size: 20,
            font: {
                size: 14,
                color: '#333'
            },
            borderWidth: 2,
            shadow: true
        },
        edges: {
            width: 2,
            shadow: true,
            smooth: {
                type: 'continuous'
            },
            font: {
                size: 12,
                align: 'middle'
            }
        },
        physics: {
            enabled: !hasSavedLayout,
            stabilization: {
                enabled: true,
                iterations: 100
            },
            barnesHut: {
                gravitationalConstant: -2000,
                centralGravity: 0.3,
                springLength: 150,
                springConstant: 0.04
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 200,
            zoomView: true,
            dragView: true
        },
        groups: {
            Person: { color: { background: '#3498db', border: '#2980b9' } },
            Company: { color: { background: '#e74c3c', border: '#c0392b' } },
            Phone: { color: { background: '#2ecc71', border: '#27ae60' } },
            Email: { color: { background: '#f39c12', border: '#e67e22' } },
            Vehicle: { color: { background: '#9b59b6', border: '#8e44ad' } },
            Address: { color: { background: '#1abc9c', border: '#16a085' } },
            SocialProfile: { color: { background: '#e67e22', border: '#d35400' } },
            Evidence: { color: { background: '#34495e', border: '#2c3e50' } },
            OsintContact: { color: { background: '#16a085', border: '#1abc9c' } },
            BankAccount: { color: { background: '#8e44ad', border: '#9b59b6' } },
            IpAddress: { color: { background: '#2c3e50', border: '#34495e' } }
        }
    };

    // Create network
    console.log('[Graph] Creating vis.Network...');
    try {
        network = new vis.Network(container, graphData, options);
        console.log('[Graph] Network created successfully:', network);

        // Fix node in place after dragging
        network.on('dragEnd', function(params) {
            if (params.nodes.length > 0) {
                params.nodes.forEach(nodeId => {
                    nodes.update({ id: nodeId, fixed: { x: true, y: true } });
                });
            }
        });

        // Single click: unfix node so it can be dragged again
        network.on('click', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                nodes.update({ id: nodeId, fixed: false });
            }
        });

        // Double click: show details (nodes) or relationship info (edges)
        network.on('doubleClick', function(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                showNodeDetails(node);
            } else if (params.edges.length > 0) {
                const edgeId = params.edges[0];
                const edge = edges.get(edgeId);
                showRelationshipDetails(edge, nodes);
            }
        });

        network.on('stabilized', function() {
            console.log('[Graph] Network stabilized');
        });

        console.log('[Graph] Event listeners attached');
    } catch (error) {
        console.error('[Graph] Error creating network:', error);
        throw error;
    }
}

// =============================================================================
// Node Details, Edit, and Delete Functions
// =============================================================================

let currentNode = null;

// Property labels for display
const propertyLabels = {
    'name': 'Nombre',
    'dni_cif': 'DNI/CIF',
    'cif': 'CIF',
    'birth_date': 'Fecha de Nacimiento',
    'number': 'Número',
    'carrier': 'Operador',
    'address': 'Dirección Email',
    'provider': 'Proveedor',
    'plate': 'Matrícula',
    'make': 'Marca',
    'model': 'Modelo',
    'street': 'Calle',
    'city': 'Ciudad',
    'postal_code': 'Código Postal',
    'platform': 'Plataforma',
    'username': 'Usuario',
    'url': 'URL',
    'filename': 'Archivo',
    'evidence_type': 'Tipo de Evidencia',
    'description': 'Descripción',
    'identifier': 'Identificador',
    'contact_type': 'Tipo de Contacto',
    'notes': 'Notas',
    'role': 'Rol',
    'created_at': 'Fecha de Creación',
    'updated_at': 'Última Actualización',
    'case_id': 'ID del Caso',
    'source': 'Origen',
    'iban': 'IBAN',
    'account_number': 'Número de Cuenta',
    'bank_name': 'Nombre del Banco',
    'ip': 'Dirección IP',
    'hostname': 'Nombre de Host'
};

// Node type colors for badges
const nodeTypeColors = {
    'Person': 'bg-primary',
    'Company': 'bg-danger',
    'Phone': 'bg-success',
    'Email': 'bg-warning text-dark',
    'Vehicle': 'bg-purple',
    'Address': 'bg-info',
    'SocialProfile': 'bg-orange',
    'Evidence': 'bg-dark',
    'OsintContact': 'bg-teal',
    'BankAccount': 'bg-purple',
    'IpAddress': 'bg-dark'
};

// Node type labels in Spanish
const nodeTypeLabels = {
    'Person': 'Persona',
    'Company': 'Empresa',
    'Phone': 'Teléfono',
    'Email': 'Email',
    'Vehicle': 'Vehículo',
    'Address': 'Dirección',
    'SocialProfile': 'Perfil Social',
    'Evidence': 'Evidencia',
    'OsintContact': 'Contacto OSINT',
    'BankAccount': 'Cuenta Bancaria',
    'IpAddress': 'Dirección IP'
};

// Editable properties by node type
const editableProperties = {
    'Person': ['name', 'dni_cif', 'birth_date', 'notes'],
    'Company': ['name', 'cif', 'notes'],
    'Phone': ['number', 'carrier', 'notes'],
    'Email': ['address', 'provider', 'notes'],
    'Vehicle': ['plate', 'make', 'model', 'notes'],
    'Address': ['street', 'city', 'postal_code', 'notes'],
    'SocialProfile': ['platform', 'username', 'url', 'notes'],
    'Evidence': ['description', 'notes'],
    'OsintContact': ['name', 'identifier', 'description', 'notes'],
    'BankAccount': ['iban', 'account_number', 'bank_name', 'notes'],
    'IpAddress': ['ip', 'hostname', 'notes']
};

// Show node details in modal
function showNodeDetails(node) {
    console.log('[NodeDetails] Node clicked:', node);
    currentNode = node;

    const nodeType = node.group;
    const properties = node.properties || {};

    // Set node type badge
    const typeBadge = document.getElementById('node-type-badge');
    typeBadge.className = `badge fs-6 ${nodeTypeColors[nodeType] || 'bg-secondary'}`;
    typeBadge.textContent = nodeTypeLabels[nodeType] || nodeType;

    // Set node ID
    document.getElementById('node-id-display').textContent = `ID: ${node.id}`;

    // Populate properties table
    const propertiesTable = document.getElementById('node-properties-table');
    let tableHtml = '';

    // Properties to skip in display
    const skipProperties = ['case_id', 'created_at', 'updated_at', 'source'];

    for (const [key, value] of Object.entries(properties)) {
        if (value !== null && value !== undefined && value !== '') {
            const label = propertyLabels[key] || key;
            let displayValue = value;

            // Format dates
            if (key.includes('date') || key.includes('_at')) {
                if (typeof value === 'string' && value.includes('T')) {
                    displayValue = new Date(value).toLocaleString('es-ES');
                }
            }

            tableHtml += `
                <tr>
                    <th style="width: 30%;">${label}</th>
                    <td>${displayValue}</td>
                </tr>
            `;
        }
    }

    if (!tableHtml) {
        tableHtml = '<tr><td colspan="2" class="text-muted text-center">No hay propiedades</td></tr>';
    }

    propertiesTable.innerHTML = tableHtml;

    // Ensure we're in view mode
    document.getElementById('node-view-mode').style.display = 'block';
    document.getElementById('node-edit-mode').style.display = 'none';
    document.getElementById('node-view-buttons').style.display = 'block';
    document.getElementById('node-edit-buttons').style.display = 'none';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('nodeDetailsModal'));
    modal.show();
}

// Enter edit mode
function enterEditMode() {
    if (!currentNode) return;

    const nodeType = currentNode.group;
    const properties = currentNode.properties || {};
    const editable = editableProperties[nodeType] || [];

    // Build edit form
    const editFields = document.getElementById('node-edit-fields');
    let formHtml = '';

    for (const prop of editable) {
        const label = propertyLabels[prop] || prop;
        const value = properties[prop] || '';
        const inputType = prop.includes('date') ? 'date' : 'text';

        formHtml += `
            <div class="mb-3">
                <label class="form-label" for="edit-${prop}">${label}</label>
                ${prop === 'notes' || prop === 'description' ?
                    `<textarea class="form-control" id="edit-${prop}" name="${prop}" rows="3">${value}</textarea>` :
                    `<input type="${inputType}" class="form-control" id="edit-${prop}" name="${prop}" value="${value}">`
                }
            </div>
        `;
    }

    if (!formHtml) {
        formHtml = '<p class="text-muted">Este tipo de nodo no tiene propiedades editables.</p>';
    }

    editFields.innerHTML = formHtml;

    // Inline DNI/NIE validation for Person nodes
    const dniInput = document.getElementById('edit-dni_cif');
    if (dniInput) {
        const fb = document.createElement('div');
        fb.id = 'edit-dni-feedback';
        dniInput.parentNode.insertBefore(fb, dniInput.nextSibling);
        dniInput.addEventListener('blur', async () => {
            const val = dniInput.value.trim().toUpperCase();
            if (!val) { fb.innerHTML = ''; return; }
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken) headers['X-CSRFToken'] = csrfToken;
            try {
                const resp = await fetch('/plugins/api/validate-dni', {
                    method: 'POST', headers,
                    body: JSON.stringify({ identifier: val })
                });
                const data = await resp.json();
                fb.innerHTML = data.valid
                    ? `<small class="text-success"><i class="bi bi-check-circle-fill"></i> ${data.type} válido</small>`
                    : `<small class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> ${data.error || 'Formato incorrecto'}${data.expected_letter ? ` — letra esperada: <strong>${data.expected_letter}</strong>` : ''}</small>`;
            } catch (e) { fb.innerHTML = ''; }
        });
    }

    // Switch to edit mode
    document.getElementById('node-view-mode').style.display = 'none';
    document.getElementById('node-edit-mode').style.display = 'block';
    document.getElementById('node-view-buttons').style.display = 'none';
    document.getElementById('node-edit-buttons').style.display = 'block';
}

// Cancel edit mode
function cancelEditMode() {
    document.getElementById('node-view-mode').style.display = 'block';
    document.getElementById('node-edit-mode').style.display = 'none';
    document.getElementById('node-view-buttons').style.display = 'block';
    document.getElementById('node-edit-buttons').style.display = 'none';
}

// Save node changes
async function saveNodeChanges() {
    if (!currentNode) return;

    const nodeType = currentNode.group;
    const editable = editableProperties[nodeType] || [];

    // Collect form data
    const properties = {};
    for (const prop of editable) {
        const input = document.getElementById(`edit-${prop}`);
        if (input) {
            properties[prop] = input.value;
        }
    }

    console.log('[NodeDetails] Saving changes:', properties);

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/graph/api/node/${currentNode.id}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                case_id: {{ case.id }},
                node_type: nodeType,
                properties: properties
            })
        });

        const responseText = await response.text();
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error('[NodeDetails] Response is not JSON:', responseText.substring(0, 200));
            throw new Error('El servidor devolvió una respuesta inesperada');
        }

        if (!response.ok) {
            throw new Error(result.error || `HTTP error! status: ${response.status}`);
        }

        console.log('[NodeDetails] Update result:', result);

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('nodeDetailsModal'));
        modal.hide();

        // Show success message
        alert('Nodo actualizado correctamente');

        // Reload graph to reflect changes
        reloadGraph();

    } catch (error) {
        console.error('[NodeDetails] Error updating node:', error);
        alert('Error al actualizar el nodo: ' + error.message);
    }
}

// Confirm delete node
function confirmDeleteNode() {
    if (!currentNode) return;

    // Set node label in confirmation modal
    document.getElementById('delete-node-label').textContent = currentNode.label || currentNode.id;

    // Hide details modal, show confirmation
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('nodeDetailsModal'));
    detailsModal.hide();

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteNodeModal'));
    deleteModal.show();
}

// Execute delete node
async function executeDeleteNode() {
    if (!currentNode) return;

    const nodeType = currentNode.group;

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/graph/api/node/${currentNode.id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                case_id: {{ case.id }},
                node_type: nodeType
            })
        });

        const responseText = await response.text();
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error('[NodeDetails] Response is not JSON:', responseText.substring(0, 200));
            throw new Error('El servidor devolvió una respuesta inesperada. Asegúrate de reiniciar el servidor.');
        }

        if (!response.ok) {
            throw new Error(result.error || `HTTP error! status: ${response.status}`);
        }

        console.log('[NodeDetails] Delete result:', result);

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteNodeModal'));
        modal.hide();

        // Show success message
        alert('Nodo eliminado correctamente');

        // Clear current node reference
        currentNode = null;

        // Reload graph to reflect changes
        reloadGraph();

    } catch (error) {
        console.error('[NodeDetails] Error deleting node:', error);
        alert('Error al eliminar el nodo: ' + error.message);
    }
}

// =============================================================================
// Relationship Details, Edit, and Delete Functions
// =============================================================================

let currentRelationship = null;
let graphNodes = null;  // Store reference to nodes DataSet

// Relationship type labels in Spanish
const relationshipTypeLabels = {
    'FAMILIAR_DE': 'Familiar de',
    'SOCIO_DE': 'Socio de',
    'EMPLEADO_DE': 'Empleado de',
    'UTILIZA_TELEFONO': 'Utiliza teléfono',
    'UTILIZA_EMAIL': 'Utiliza email',
    'UTILIZA_VEHICULO': 'Utiliza vehículo',
    'PROPIETARIO_DE': 'Propietario de',
    'RESIDE_EN': 'Reside en',
    'VISTO_EN': 'Visto en',
    'CONTACTO_CON': 'Contacto con',
    'VINCULADO_A_EVIDENCIA': 'Vinculado a evidencia',
    'PERFIL_DE': 'Perfil de',
    'TITULAR_DE': 'Titular de',
    'TRANSFERENCIA_A': 'Transferencia a',
    'CONEXION_DESDE': 'Conexión desde'
};

// Property labels for relationships
const relPropertyLabels = {
    'confidence': 'Confianza',
    'start_date': 'Fecha de Inicio',
    'end_date': 'Fecha de Fin',
    'notes': 'Notas',
    'created_at': 'Fecha de Creación',
    'updated_at': 'Última Actualización'
};

// Show relationship details in modal
function showRelationshipDetails(edge, nodes) {
    console.log('[RelDetails] Edge clicked:', edge);
    currentRelationship = edge;
    graphNodes = nodes;

    const properties = edge.properties || {};

    // Set relationship type badge
    const typeBadge = document.getElementById('rel-type-badge');
    const relType = edge.title || edge.label || 'Relación';
    typeBadge.textContent = relationshipTypeLabels[relType] || relType.replace(/_/g, ' ');

    // Set relationship ID
    document.getElementById('rel-id-display').textContent = `ID: ${edge.id}`;

    // Set from/to labels
    const fromNode = nodes.get(edge.from);
    const toNode = nodes.get(edge.to);
    document.getElementById('rel-from-label').textContent = fromNode ? fromNode.label : edge.from;
    document.getElementById('rel-to-label').textContent = toNode ? toNode.label : edge.to;

    // Populate properties table
    const propertiesTable = document.getElementById('rel-properties-table');
    let tableHtml = '';

    for (const [key, value] of Object.entries(properties)) {
        if (value !== null && value !== undefined && value !== '') {
            const label = relPropertyLabels[key] || propertyLabels[key] || key;
            let displayValue = value;

            // Format confidence as percentage
            if (key === 'confidence') {
                displayValue = `${Math.round(value * 100)}%`;
            }
            // Format dates
            else if (key.includes('date') || key.includes('_at')) {
                if (typeof value === 'string' && value.includes('T')) {
                    displayValue = new Date(value).toLocaleString('es-ES');
                } else if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    displayValue = new Date(value).toLocaleDateString('es-ES');
                }
            }

            tableHtml += `
                <tr>
                    <th style="width: 30%;">${label}</th>
                    <td>${displayValue}</td>
                </tr>
            `;
        }
    }

    if (!tableHtml) {
        tableHtml = '<tr><td colspan="2" class="text-muted text-center">No hay propiedades adicionales</td></tr>';
    }

    propertiesTable.innerHTML = tableHtml;

    // Ensure we're in view mode
    document.getElementById('rel-view-mode').style.display = 'block';
    document.getElementById('rel-edit-mode').style.display = 'none';
    document.getElementById('rel-view-buttons').style.display = 'block';
    document.getElementById('rel-edit-buttons').style.display = 'none';

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('relationshipDetailsModal'));
    modal.show();
}

// Enter relationship edit mode
function enterRelEditMode() {
    if (!currentRelationship) return;

    const properties = currentRelationship.properties || {};

    // Set confidence slider
    const confidence = properties.confidence || 1;
    document.getElementById('edit-rel-confidence').value = confidence;
    document.getElementById('confidence-value').textContent = Math.round(confidence * 100);

    // Set dates
    document.getElementById('edit-rel-start_date').value = properties.start_date || '';
    document.getElementById('edit-rel-end_date').value = properties.end_date || '';

    // Set notes
    document.getElementById('edit-rel-notes').value = properties.notes || '';

    // Add confidence slider event listener
    document.getElementById('edit-rel-confidence').oninput = function() {
        document.getElementById('confidence-value').textContent = Math.round(this.value * 100);
    };

    // Switch to edit mode
    document.getElementById('rel-view-mode').style.display = 'none';
    document.getElementById('rel-edit-mode').style.display = 'block';
    document.getElementById('rel-view-buttons').style.display = 'none';
    document.getElementById('rel-edit-buttons').style.display = 'block';
}

// Cancel relationship edit mode
function cancelRelEditMode() {
    document.getElementById('rel-view-mode').style.display = 'block';
    document.getElementById('rel-edit-mode').style.display = 'none';
    document.getElementById('rel-view-buttons').style.display = 'block';
    document.getElementById('rel-edit-buttons').style.display = 'none';
}

// Save relationship changes
async function saveRelationshipChanges() {
    if (!currentRelationship) return;

    // Collect form data
    const properties = {
        confidence: parseFloat(document.getElementById('edit-rel-confidence').value),
        start_date: document.getElementById('edit-rel-start_date').value || null,
        end_date: document.getElementById('edit-rel-end_date').value || null,
        notes: document.getElementById('edit-rel-notes').value || null
    };

    console.log('[RelDetails] Saving changes:', properties);

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/graph/api/relationship/${currentRelationship.id}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                case_id: {{ case.id }},
                properties: properties
            })
        });

        const responseText = await response.text();
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error('[RelDetails] Response is not JSON:', responseText.substring(0, 200));
            throw new Error('El servidor devolvió una respuesta inesperada');
        }

        if (!response.ok) {
            throw new Error(result.error || `HTTP error! status: ${response.status}`);
        }

        console.log('[RelDetails] Update result:', result);

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('relationshipDetailsModal'));
        modal.hide();

        // Show success message
        alert('Relación actualizada correctamente');

        // Reload graph to reflect changes
        reloadGraph();

    } catch (error) {
        console.error('[RelDetails] Error updating relationship:', error);
        alert('Error al actualizar la relación: ' + error.message);
    }
}

// Confirm delete relationship
function confirmDeleteRelationship() {
    if (!currentRelationship) return;

    // Set relationship label in confirmation modal
    const relType = currentRelationship.title || currentRelationship.label || 'Relación';
    document.getElementById('delete-rel-label').textContent = relationshipTypeLabels[relType] || relType.replace(/_/g, ' ');

    // Hide details modal, show confirmation
    const detailsModal = bootstrap.Modal.getInstance(document.getElementById('relationshipDetailsModal'));
    detailsModal.hide();

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteRelationshipModal'));
    deleteModal.show();
}

// Execute delete relationship
async function executeDeleteRelationship() {
    if (!currentRelationship) return;

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(`/graph/api/relationship/${currentRelationship.id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                case_id: {{ case.id }}
            })
        });

        const responseText = await response.text();
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (e) {
            console.error('[RelDetails] Response is not JSON:', responseText.substring(0, 200));
            throw new Error('El servidor devolvió una respuesta inesperada');
        }

        if (!response.ok) {
            throw new Error(result.error || `HTTP error! status: ${response.status}`);
        }

        console.log('[RelDetails] Delete result:', result);

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteRelationshipModal'));
        modal.hide();

        // Show success message
        alert('Relación eliminada correctamente');

        // Clear current relationship reference
        currentRelationship = null;

        // Reload graph to reflect changes
        reloadGraph();

    } catch (error) {
        console.error('[RelDetails] Error deleting relationship:', error);
        alert('Error al eliminar la relación: ' + error.message);
    }
}

// Update counts
function updateCounts(data) {
    document.getElementById('node-count').textContent = data.nodes.length;
    document.getElementById('relationship-count').textContent = data.edges.length;
}

// Reset graph view
function resetGraph() {
    if (network) {
        network.fit({
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    }
}

// Reload graph from server
function reloadGraph() {
    console.log('[Graph] Reloading graph...');

    // Destroy existing network
    if (network) {
        network.destroy();
        network = null;
        console.log('[Graph] Network destroyed');
    }

    // Reset container and show loading
    const container = document.getElementById('graph-container');
    container.innerHTML = `
        <div id="graph-loading" class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center text-muted">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3">Recargando grafo...</p>
            </div>
        </div>
    `;

    // Hide legend
    document.getElementById('graph-legend').style.display = 'none';

    // Reload data
    loadGraphData();
}

// Save layout button
document.getElementById('save-layout-button').addEventListener('click', async function() {
    if (!network) return;
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Guardando...';
    const result = await saveAllPositions();
    if (result && result.success) {
        btn.innerHTML = '<i class="bi bi-check-circle"></i> Guardado';
    } else {
        btn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error';
    }
    setTimeout(() => {
        btn.innerHTML = '<i class="bi bi-save"></i> Guardar Layout';
        btn.disabled = false;
    }, 2000);
});

// Reset layout button
document.getElementById('reset-layout-button').addEventListener('click', async function() {
    if (!confirm('¿Resetear el layout? Los nodos volverán a posicionarse automáticamente.')) return;
    try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        await fetch('/graph/api/case/{{ case.id }}/layout', {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken }
        });
        savedPositions = {};
        hasSavedLayout = false;
        // Reload graph with physics enabled
        reloadGraph();
    } catch (e) {
        console.error('[Layout] Error al resetear layout:', e);
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadGraphData();
});

// =============================================================================
// Import Case Elements Functions
// =============================================================================

let caseElements = null;
let selectedElements = new Map();

// Load case elements for import modal
async function loadCaseElements() {
    console.log('[Import] Loading case elements...');

    // Reset state
    selectedElements.clear();
    updateSelectionUI();

    // Show loading states
    ['evidencias', 'contactos', 'sujetos'].forEach(type => {
        document.getElementById(`${type}-loading`).style.display = 'block';
        document.getElementById(`${type}-list`).style.display = 'none';
        document.getElementById(`${type}-empty`).style.display = 'none';
    });

    try {
        const url = '{{ url_for("graph.api_case_elements", case_id=case.id) }}';
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        caseElements = await response.json();
        console.log('[Import] Case elements loaded:', caseElements);

        // Update counts
        document.getElementById('evidencias-count').textContent = caseElements.counts.evidences;
        document.getElementById('contactos-count').textContent = caseElements.counts.contacts;
        document.getElementById('sujetos-count').textContent = caseElements.counts.sujetos;

        // Render lists
        renderEvidenciasList(caseElements.evidences);
        renderContactosList(caseElements.contacts);
        renderSujetosList(caseElements.sujetos);

    } catch (error) {
        console.error('[Import] Error loading case elements:', error);
        ['evidencias', 'contactos', 'sujetos'].forEach(type => {
            document.getElementById(`${type}-loading`).innerHTML = `
                <div class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error al cargar: ${error.message}
                </div>
            `;
        });
    }
}

// Render evidencias list
function renderEvidenciasList(evidences) {
    const loading = document.getElementById('evidencias-loading');
    const list = document.getElementById('evidencias-list');
    const empty = document.getElementById('evidencias-empty');

    loading.style.display = 'none';

    if (!evidences || evidences.length === 0) {
        empty.style.display = 'block';
        return;
    }

    list.innerHTML = evidences.map(e => `
        <label class="list-group-item list-group-item-action d-flex align-items-center ${e.has_node ? 'bg-light' : ''}">
            <input type="checkbox" class="form-check-input me-3 element-checkbox"
                   data-type="evidence" data-id="${e.id}"
                   ${e.has_node ? 'disabled' : ''}
                   onchange="toggleElement(this)">
            <div class="flex-grow-1">
                <div class="fw-bold">
                    <i class="bi bi-file-earmark-${getEvidenceIcon(e.evidence_type)}"></i>
                    ${e.name}
                </div>
                <small class="text-muted">
                    ${e.evidence_type} | ${e.sha256_hash || 'Sin hash'}
                    ${e.has_node ? '<span class="badge bg-info ms-2">Ya en grafo</span>' : ''}
                </small>
            </div>
        </label>
    `).join('');

    list.style.display = 'block';
}

// Render contactos list
function renderContactosList(contacts) {
    const loading = document.getElementById('contactos-loading');
    const list = document.getElementById('contactos-list');
    const empty = document.getElementById('contactos-empty');

    loading.style.display = 'none';

    if (!contacts || contacts.length === 0) {
        empty.style.display = 'block';
        return;
    }

    list.innerHTML = contacts.map(c => `
        <label class="list-group-item list-group-item-action d-flex align-items-center">
            <input type="checkbox" class="form-check-input me-3 element-checkbox"
                   data-type="osint_contact" data-id="${c.id}"
                   onchange="toggleElement(this)">
            <div class="flex-grow-1">
                <div class="fw-bold">
                    <i class="bi bi-${getContactIcon(c.contact_type)}"></i>
                    ${c.name || c.contact_value}
                </div>
                <small class="text-muted">
                    ${c.contact_type}: ${c.contact_value}
                    ${c.is_validated ? '<span class="badge bg-success ms-2">Validado</span>' : ''}
                    ${c.risk_level ? `<span class="badge bg-${getRiskBadgeClass(c.risk_level)} ms-1">${c.risk_level}</span>` : ''}
                </small>
            </div>
        </label>
    `).join('');

    list.style.display = 'block';
}

// Render sujetos list
function renderSujetosList(sujetos) {
    const loading = document.getElementById('sujetos-loading');
    const list = document.getElementById('sujetos-list');
    const empty = document.getElementById('sujetos-empty');

    loading.style.display = 'none';

    if (!sujetos || sujetos.length === 0) {
        empty.style.display = 'block';
        return;
    }

    list.innerHTML = sujetos.map(s => `
        <label class="list-group-item list-group-item-action d-flex align-items-center">
            <input type="checkbox" class="form-check-input me-3 element-checkbox"
                   data-type="sujeto" data-id="${s.id}" data-name="${s.name}" data-dni="${s.dni_nie || ''}" data-index="${s.index}"
                   onchange="toggleElement(this)">
            <div class="flex-grow-1">
                <div class="fw-bold">
                    <i class="bi bi-person-fill"></i>
                    ${s.name}
                </div>
                <small class="text-muted">
                    ${s.dni_nie ? `DNI/NIE: ${s.dni_nie}` : 'Sin identificación'}
                    <span class="badge bg-warning ms-2">Sujeto investigado</span>
                </small>
            </div>
        </label>
    `).join('');

    list.style.display = 'block';
}

// Toggle element selection
function toggleElement(checkbox) {
    const type = checkbox.dataset.type;
    const id = checkbox.dataset.id;
    const key = `${type}:${id}`;

    if (checkbox.checked) {
        const elementData = { type, id };
        if (type === 'sujeto') {
            elementData.name = checkbox.dataset.name;
            elementData.dni_nie = checkbox.dataset.dni;
            elementData.index = parseInt(checkbox.dataset.index);
        }
        selectedElements.set(key, elementData);
    } else {
        selectedElements.delete(key);
    }

    updateSelectionUI();
}

// Setup event delegation for checkboxes (handles dynamically created elements)
document.addEventListener('change', function(e) {
    if (e.target && e.target.classList.contains('element-checkbox')) {
        toggleElement(e.target);
    }
});

// Update selection UI
function updateSelectionUI() {
    const count = selectedElements.size;
    document.getElementById('selected-count').textContent = count;
    document.getElementById('import-count').textContent = count;
    document.getElementById('selection-summary').style.display = count > 0 ? 'block' : 'none';
    document.getElementById('btn-import').disabled = count === 0;
}

// Select all elements
function selectAllElements() {
    const checkboxes = document.querySelectorAll('.element-checkbox:not(:disabled)');
    checkboxes.forEach(cb => {
        if (!cb.checked) {
            cb.checked = true;
            // Manually trigger the toggle since we're setting programmatically
            const type = cb.dataset.type;
            const id = cb.dataset.id;
            const key = `${type}:${id}`;
            const elementData = { type, id };
            if (type === 'sujeto') {
                elementData.name = cb.dataset.name;
                elementData.dni_nie = cb.dataset.dni;
                elementData.index = parseInt(cb.dataset.index);
            }
            selectedElements.set(key, elementData);
        }
    });
    updateSelectionUI();
}

// Deselect all elements
function deselectAllElements() {
    const checkboxes = document.querySelectorAll('.element-checkbox');
    checkboxes.forEach(cb => {
        if (cb.checked) {
            cb.checked = false;
        }
    });
    selectedElements.clear();
    updateSelectionUI();
}

// Import selected elements
async function importSelectedElements() {
    if (selectedElements.size === 0) return;

    const btn = document.getElementById('btn-import');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importando...';

    try {
        const elements = Array.from(selectedElements.values());
        console.log('[Import] Importing elements:', elements);

        // Get CSRF token from meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        const response = await fetch('{{ url_for("graph.api_import_elements", case_id=case.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ elements })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('[Import] Import result:', result);

        // Show result message
        let message = `Importados: ${result.summary.created} nodos`;
        if (result.summary.skipped > 0) {
            message += `, ${result.summary.skipped} omitidos`;
        }
        if (result.summary.errors > 0) {
            message += `, ${result.summary.errors} errores`;
        }

        alert(message);

        // Close modal and reload graph
        const modal = bootstrap.Modal.getInstance(document.getElementById('importElementsModal'));
        modal.hide();

        // Reload graph to show new nodes
        reloadGraph();

    } catch (error) {
        console.error('[Import] Error importing elements:', error);
        alert('Error al importar elementos: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Helper functions for icons and badges
function getEvidenceIcon(type) {
    const icons = {
        'Imagen': 'image',
        'Vídeo': 'play',
        'Audio': 'music-note',
        'Documento': 'text',
        'Captura Web': 'globe',
        'Email': 'envelope',
        'Datos Digitales': 'database'
    };
    return icons[type] || 'file';
}

function getContactIcon(type) {
    const icons = {
        'email': 'envelope',
        'phone': 'telephone',
        'social_profile': 'person-circle',
        'username': 'person-badge',
        'other': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

function getRiskBadgeClass(level) {
    const classes = {
        'low': 'success',
        'medium': 'warning',
        'high': 'warning',
        'very_high': 'danger'
    };
    return classes[level] || 'secondary';
}
</script>
{% endblock %}
