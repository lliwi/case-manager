{% extends "base.html" %}

{% block title %}Crear Copia de Seguridad - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-cloud-upload"></i> Crear Copia de Seguridad
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.create_backup') }}" id="backupForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            Selecciona los componentes que deseas incluir en la copia de seguridad.
                            Se recomienda incluir todos los componentes para una copia completa.
                        </div>

                        <!-- Components Selection -->
                        <h5 class="mb-3"><i class="bi bi-box-seam"></i> Componentes</h5>

                        <div class="row">
                            <!-- Database -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="include_database" id="include_database" checked>
                                            <label class="form-check-label" for="include_database">
                                                <i class="bi bi-database text-primary"></i>
                                                <strong>Base de Datos PostgreSQL</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Incluye todas las tablas: casos, usuarios, evidencias, logs de auditoría, etc.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Evidence -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="include_evidence" id="include_evidence" checked>
                                            <label class="form-check-label" for="include_evidence">
                                                <i class="bi bi-file-earmark-lock text-success"></i>
                                                <strong>Evidencias</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Archivos de evidencias cifradas con AES-256 y media de monitorización OSINT.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Uploads -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="include_uploads" id="include_uploads" checked>
                                            <label class="form-check-label" for="include_uploads">
                                                <i class="bi bi-cloud-arrow-up text-info"></i>
                                                <strong>Uploads</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Archivos subidos por usuarios (temporales, adjuntos, etc.).
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Exports -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="include_exports" id="include_exports" checked>
                                            <label class="form-check-label" for="include_exports">
                                                <i class="bi bi-box-arrow-up-right text-warning"></i>
                                                <strong>Exports</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Archivos exportados (CSVs, datos de casos, etc.).
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Reports -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="include_reports" id="include_reports" checked>
                                            <label class="form-check-label" for="include_reports">
                                                <i class="bi bi-file-pdf text-danger"></i>
                                                <strong>Informes</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Informes generados en PDF y otros formatos.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- API Keys -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-warning">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="include_api_keys" id="include_api_keys" checked>
                                            <label class="form-check-label" for="include_api_keys">
                                                <i class="bi bi-key text-warning"></i>
                                                <strong>API Keys</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            <span class="text-warning"><i class="bi bi-exclamation-triangle"></i></span>
                                            Claves API descifradas. Maneje con cuidado.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Environment Config -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-danger">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="include_env" id="include_env" checked>
                                            <label class="form-check-label" for="include_env">
                                                <i class="bi bi-gear text-danger"></i>
                                                <strong>Configuración (.env)</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            <span class="text-danger"><i class="bi bi-exclamation-triangle"></i></span>
                                            Contiene secretos y credenciales. Maneje con extremo cuidado.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Warning -->
                        <div class="alert alert-warning alert-permanent mt-3">
                            <i class="bi bi-shield-exclamation"></i>
                            <strong>Advertencia de Seguridad:</strong>
                            <ul class="mb-0 mt-2">
                                <li>El archivo de backup contendrá información altamente sensible.</li>
                                <li>Almacene el backup en un lugar seguro con acceso restringido.</li>
                                <li>Considere cifrar el archivo ZIP con una contraseña adicional.</li>
                                <li>No comparta el backup por canales inseguros.</li>
                            </ul>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('admin.backups') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="bi bi-cloud-upload"></i> Crear Copia de Seguridad
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Select Buttons -->
            <div class="card mt-3">
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
                            <i class="bi bi-check-all"></i> Seleccionar Todo
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectNone()">
                            <i class="bi bi-x-lg"></i> Deseleccionar Todo
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="selectEssential()">
                            <i class="bi bi-star"></i> Solo Esenciales (DB + Evidencias)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function selectAll() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
}

function selectNone() {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function selectEssential() {
    selectNone();
    document.getElementById('include_database').checked = true;
    document.getElementById('include_evidence').checked = true;
}

document.getElementById('backupForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creando backup... Esto puede tardar varios minutos.';

    // Show progress overlay
    const overlay = document.createElement('div');
    overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
    overlay.style.zIndex = '9999';
    overlay.innerHTML = `
        <div class="card p-4 text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h5>Creando copia de seguridad...</h5>
            <p class="text-muted mb-0">Este proceso puede tardar varios minutos dependiendo del tamaño de los datos.</p>
            <p class="text-muted small">No cierre esta ventana.</p>
        </div>
    `;
    document.body.appendChild(overlay);
});
</script>
{% endblock %}
