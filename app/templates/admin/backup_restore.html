{% extends "base.html" %}

{% block title %}Restaurar Backup - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="bi bi-arrow-counterclockwise"></i> Restaurar Copia de Seguridad
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Backup Info -->
                    <div class="alert alert-info alert-permanent">
                        <h6><i class="bi bi-file-earmark-zip"></i> {{ filename }}</h6>
                        <p class="mb-0">
                            <strong>Tamaño:</strong>
                            {% if backup.size > 1073741824 %}
                                {{ "%.2f"|format(backup.size / 1073741824) }} GB
                            {% elif backup.size > 1048576 %}
                                {{ "%.2f"|format(backup.size / 1048576) }} MB
                            {% else %}
                                {{ "%.2f"|format(backup.size / 1024) }} KB
                            {% endif %}
                        </p>
                        {% if backup.manifest %}
                        <p class="mb-0"><strong>Creado:</strong> {{ backup.manifest.created_at }}</p>
                        <p class="mb-0"><strong>Por:</strong> {{ backup.manifest.created_by }}</p>
                        {% endif %}
                    </div>

                    <form method="POST" action="{{ url_for('admin.restore_backup', filename=filename) }}" id="restoreForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Danger Warning -->
                        <div class="alert alert-danger alert-permanent">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>ADVERTENCIA:</strong> La restauración puede sobrescribir datos existentes.
                            Esta operación no se puede deshacer. Asegúrese de tener una copia de seguridad
                            actual antes de proceder.
                        </div>

                        <!-- Components Selection -->
                        <h5 class="mb-3"><i class="bi bi-box-seam"></i> Componentes a Restaurar</h5>

                        <div class="row">
                            <!-- Database -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="restore_database" id="restore_database"
                                                   {% if backup.manifest and 'database' in backup.manifest.components %}checked{% endif %}>
                                            <label class="form-check-label" for="restore_database">
                                                <i class="bi bi-database text-primary"></i>
                                                <strong>Base de Datos</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Restaura todas las tablas de PostgreSQL.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Evidence -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="restore_evidence" id="restore_evidence"
                                                   {% if backup.manifest and 'evidence' in backup.manifest.components %}checked{% endif %}>
                                            <label class="form-check-label" for="restore_evidence">
                                                <i class="bi bi-file-earmark-lock text-success"></i>
                                                <strong>Evidencias</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Archivos de evidencias cifradas.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Uploads -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="restore_uploads" id="restore_uploads"
                                                   {% if backup.manifest and 'uploads' in backup.manifest.components %}checked{% endif %}>
                                            <label class="form-check-label" for="restore_uploads">
                                                <i class="bi bi-cloud-arrow-up text-info"></i>
                                                <strong>Uploads</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Archivos subidos por usuarios.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Exports -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="restore_exports" id="restore_exports"
                                                   {% if backup.manifest and 'exports' in backup.manifest.components %}checked{% endif %}>
                                            <label class="form-check-label" for="restore_exports">
                                                <i class="bi bi-box-arrow-up-right text-warning"></i>
                                                <strong>Exports</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Archivos exportados.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Reports -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="restore_reports" id="restore_reports"
                                                   {% if backup.manifest and 'reports' in backup.manifest.components %}checked{% endif %}>
                                            <label class="form-check-label" for="restore_reports">
                                                <i class="bi bi-file-pdf text-danger"></i>
                                                <strong>Informes</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Informes generados en PDF.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- API Keys -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-warning">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="restore_api_keys" id="restore_api_keys"
                                                   {% if backup.manifest and 'api_keys' in backup.manifest.components %}checked{% endif %}>
                                            <label class="form-check-label" for="restore_api_keys">
                                                <i class="bi bi-key text-warning"></i>
                                                <strong>API Keys</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            Restaura o actualiza las claves API.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Environment Config -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-danger">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="restore_env" id="restore_env">
                                            <label class="form-check-label" for="restore_env">
                                                <i class="bi bi-gear text-danger"></i>
                                                <strong>Configuración (.env)</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            <span class="text-danger"><i class="bi bi-exclamation-triangle"></i></span>
                                            <strong>PELIGROSO:</strong> Puede romper el sistema si las credenciales no coinciden.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Clear existing -->
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-danger">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                   name="clear_existing" id="clear_existing">
                                            <label class="form-check-label" for="clear_existing">
                                                <i class="bi bi-trash text-danger"></i>
                                                <strong>Limpiar Existentes</strong>
                                            </label>
                                        </div>
                                        <p class="text-muted small mt-2 mb-0">
                                            <span class="text-danger"><i class="bi bi-exclamation-triangle"></i></span>
                                            Elimina los archivos existentes antes de restaurar.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Confirmation -->
                        <div class="form-check mt-4 mb-3">
                            <input class="form-check-input" type="checkbox" id="confirm_restore" required>
                            <label class="form-check-label text-danger" for="confirm_restore">
                                <strong>Confirmo que entiendo los riesgos y deseo proceder con la restauración.</strong>
                            </label>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('admin.backups') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-warning" id="submitBtn">
                                <i class="bi bi-arrow-counterclockwise"></i> Restaurar Backup
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('restoreForm').addEventListener('submit', function(e) {
    if (!document.getElementById('confirm_restore').checked) {
        e.preventDefault();
        alert('Debe confirmar que entiende los riesgos antes de proceder.');
        return false;
    }

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restaurando... Esto puede tardar varios minutos.';

    // Show progress overlay
    const overlay = document.createElement('div');
    overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
    overlay.style.zIndex = '9999';
    overlay.innerHTML = `
        <div class="card p-4 text-center">
            <div class="spinner-border text-warning mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h5>Restaurando copia de seguridad...</h5>
            <p class="text-muted mb-0">Este proceso puede tardar varios minutos.</p>
            <p class="text-muted small">No cierre esta ventana.</p>
        </div>
    `;
    document.body.appendChild(overlay);
});
</script>
{% endblock %}
