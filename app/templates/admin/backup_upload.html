{% extends "base.html" %}

{% block title %}Subir Backup - Admin{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-cloud-arrow-up"></i> Subir Copia de Seguridad
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info alert-permanent">
                        <i class="bi bi-info-circle"></i>
                        Sube un archivo de backup previamente generado por este sistema.
                        El archivo debe tener el formato <code>backup_YYYYMMDD_HHMMSS.zip</code>.
                    </div>

                    <form method="POST" action="{{ url_for('admin.upload_backup') }}"
                          enctype="multipart/form-data" id="uploadForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="mb-4">
                            <label for="backup_file" class="form-label">
                                <i class="bi bi-file-earmark-zip"></i> Archivo de Backup
                            </label>
                            <input class="form-control form-control-lg" type="file"
                                   id="backup_file" name="backup_file"
                                   accept=".zip" required>
                            <div class="form-text">
                                Solo se aceptan archivos ZIP con el formato correcto.
                            </div>
                        </div>

                        <!-- File info (shown after selection) -->
                        <div id="fileInfo" class="alert alert-secondary d-none">
                            <strong>Archivo seleccionado:</strong>
                            <span id="fileName"></span>
                            (<span id="fileSize"></span>)
                        </div>

                        <!-- Warning -->
                        <div class="alert alert-warning alert-permanent">
                            <i class="bi bi-shield-exclamation"></i>
                            <strong>Importante:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Solo suba archivos de backup generados por este sistema.</li>
                                <li>No modifique el contenido del archivo ZIP.</li>
                                <li>Asegúrese de que el archivo no esté corrupto.</li>
                            </ul>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('admin.backups') }}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-info" id="submitBtn" disabled>
                                <i class="bi bi-cloud-arrow-up"></i> Subir Backup
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('backup_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const submitBtn = document.getElementById('submitBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');

    if (file) {
        // Show file info
        fileName.textContent = file.name;

        // Format file size
        let size = file.size;
        if (size > 1073741824) {
            fileSize.textContent = (size / 1073741824).toFixed(2) + ' GB';
        } else if (size > 1048576) {
            fileSize.textContent = (size / 1048576).toFixed(2) + ' MB';
        } else {
            fileSize.textContent = (size / 1024).toFixed(2) + ' KB';
        }

        fileInfo.classList.remove('d-none');

        // Validate filename format
        const validFormat = /^backup_\d{8}_\d{6}\.zip$/.test(file.name);
        if (validFormat) {
            submitBtn.disabled = false;
            fileInfo.classList.remove('alert-danger');
            fileInfo.classList.add('alert-secondary');
        } else {
            submitBtn.disabled = true;
            fileInfo.classList.remove('alert-secondary');
            fileInfo.classList.add('alert-danger');
            fileInfo.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Formato inválido:</strong> ${file.name}<br>
                El archivo debe llamarse <code>backup_YYYYMMDD_HHMMSS.zip</code>
            `;
        }
    } else {
        fileInfo.classList.add('d-none');
        submitBtn.disabled = true;
    }
});

document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Subiendo...';
});
</script>
{% endblock %}
