{% extends "base.html" %}

{% block title %}Timeline - Caso {{ case.numero_orden }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3">
                        <i class="bi bi-clock-history"></i> Timeline - Caso {{ case.numero_orden }}
                    </h1>
                    <p class="text-muted mb-0">{{ case.objeto_investigacion }}</p>
                </div>
                <div>
                    <a href="{{ url_for('cases.detail', case_id=case.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Volver al Caso
                    </a>
                    <a href="{{ url_for('timeline.create_event', case_id=case.id) }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nuevo Evento
                    </a>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-muted">Total Eventos</h6>
                            <h3>{{ stats.total_events }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-muted">Con Evidencia</h6>
                            <h3>{{ stats.events_with_evidence }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-muted">Sujetos</h6>
                            <h3>{{ stats.subjects|length }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="text-muted">Período</h6>
                            <p class="mb-0">
                                {% if stats.date_range and stats.date_range.start %}
                                    {{ stats.date_range.start.strftime('%d/%m/%Y') }}<br>
                                    {{ stats.date_range.end.strftime('%d/%m/%Y') }}
                                {% else %}
                                    -
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Bar -->
            <div class="card mb-3">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('timeline.auto_create_events', case_id=case.id) }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-lightning"></i> Auto-crear desde Evidencias
                        </button>
                    </form>
                    <a href="{{ url_for('timeline.api_timeline_export', case_id=case.id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="bi bi-download"></i> Exportar JSON
                    </a>
                </div>
            </div>

            <!-- Timeline Events List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Eventos Cronológicos</h5>
                </div>
                <div class="card-body">
                    {% if events %}
                        <div class="timeline">
                            {% for event in events %}
                                <div class="timeline-item mb-4 pb-4 border-bottom">
                                    <div class="row">
                                        <div class="col-md-2 text-muted">
                                            <small>
                                                <i class="bi bi-calendar"></i>
                                                {{ event.event_date.strftime('%d/%m/%Y') }}<br>
                                                <i class="bi bi-clock"></i>
                                                {{ event.event_date.strftime('%H:%M') }}
                                            </small>
                                        </div>
                                        <div class="col-md-10">
                                            <h6>
                                                <span class="badge" style="background-color: {{ event.color or '#3498db' }}">
                                                    {{ event.event_type.value }}
                                                </span>
                                                <a href="{{ url_for('timeline.event_detail', event_id=event.id) }}">
                                                    {{ event.title }}
                                                </a>
                                            </h6>
                                            {% if event.description %}
                                                <p class="mb-2">{{ event.description }}</p>
                                            {% endif %}
                                            <div class="text-muted small">
                                                {% if event.location_name %}
                                                    <i class="bi bi-geo-alt"></i> {{ event.location_name }}
                                                {% endif %}
                                                {% if event.subjects %}
                                                    <i class="bi bi-person"></i> {{ event.subjects }}
                                                {% endif %}
                                                {% if event.evidence_id %}
                                                    <i class="bi bi-file-earmark-lock"></i> Con evidencia
                                                {% endif %}
                                                {% if event.confidence_level %}
                                                    <span class="badge bg-secondary">{{ event.confidence_level }}</span>
                                                {% endif %}
                                            </div>
                                            <div class="mt-2">
                                                <a href="{{ url_for('timeline.edit_event', event_id=event.id) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-pencil"></i> Editar
                                                </a>
                                                <form method="POST" action="{{ url_for('timeline.delete_event', event_id=event.id) }}" class="d-inline" onsubmit="return confirm('¿Eliminar este evento?');">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                                        <i class="bi bi-trash"></i> Eliminar
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-clock-history display-1 text-muted"></i>
                            <p class="mt-3">No hay eventos en el timeline.</p>
                            <a href="{{ url_for('timeline.create_event', case_id=case.id) }}" class="btn btn-primary">
                                Crear Primer Evento
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-item:last-child {
    border-bottom: none !important;
}
</style>
{% endblock %}
